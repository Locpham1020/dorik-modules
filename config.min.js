/**
 * CONFIG.MIN.JS - Core Configuration Module
 * Constants, device detection, utilities, shared functions
 */

(function() {
  'use strict';

  // === CORE CONFIGURATION ===
  window.DorikConfig = {
    // API Endpoints
    GOOGLE_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbylfd_DbjRrq90t0jIDPnjx523WhVzXxF9WtajANBLWyVqqZDqZhKu8z6_GOZ6rf9jTQw/exec',
    TALLY_FORM_ID: '31xoq1',
    
    // Performance Settings
    VIEWPORT_MARGIN: '100px',
    BATCH_SIZE: 30,
    SCROLL_DEBOUNCE: 100,
    FIREBASE_TIMEOUT: 5000,
    FIREBASE_RETRY_ATTEMPTS: 3,
    FIREBASE_RETRY_DELAY: 1000,
    
    // Cache Settings
    MAX_PRODUCT_CACHE: 100,
    MAX_IMAGE_CACHE: 200,
    MAX_MEMORY_MB: 50,
    CLEANUP_INTERVAL: 180000,
    
    // Feature Flags
    PRELOAD_NEXT_ONLY: true,
    DEBUG: true,
    
    // CDN URLs
    LIGHTGALLERY_CSS: 'https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lightgallery.min.css',
    LIGHTGALLERY_THUMB_CSS: 'https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lg-thumbnail.min.css',
    LIGHTGALLERY_JS: 'https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/lightgallery.min.js',
    LIGHTGALLERY_THUMB_JS: 'https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/plugins/thumbnail/lg-thumbnail.min.js',
    TALLY_SCRIPT: 'https://tally.so/widgets/embed.js'
  };

  // === DEVICE DETECTION ===
  window.DorikUtils = {
    
    // Comprehensive device detection
    getDeviceInfo() {
      const width = window.innerWidth;
      const height = window.innerHeight;
      const userAgent = navigator.userAgent.toLowerCase();
      const platform = navigator.platform?.toLowerCase() || '';
      
      const isMobile = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(userAgent) || width <= 768;
      const isTablet = (width > 768 && width <= 1024) || /ipad/i.test(userAgent);
      
      let deviceType = 'desktop';
      if (isMobile && width < 768) deviceType = 'mobile';
      else if (isTablet) deviceType = 'tablet';
      else if (width > 1024 && width <= 1440) deviceType = 'laptop';
      
      const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
      const effectiveType = connection?.effectiveType || '4g';
      const isSlowConnection = ['slow-2g', '2g', '3g'].includes(effectiveType);
      
      let os = 'Unknown';
      if (/iphone/i.test(userAgent)) os = 'iOS';
      else if (/ipad/i.test(userAgent)) os = 'iPadOS';
      else if (/android/i.test(userAgent)) os = 'Android';
      else if (/windows/i.test(userAgent)) os = 'Windows';
      else if (/macintosh|mac os x/i.test(userAgent)) os = 'macOS';
      else if (/linux/i.test(userAgent) && !/android/i.test(userAgent)) os = 'Linux';
      else if (/cros/i.test(userAgent)) os = 'ChromeOS';
      else if (platform.includes('win')) os = 'Windows';
      else if (platform.includes('mac')) os = 'macOS';
      else if (platform.includes('linux')) os = 'Linux';
      else if (isMobile) {
        os = width <= 414 && height <= 896 ? 'iOS' : 'Android';
      }
      
      return {
        device: deviceType,
        os: os,
        screenWidth: width,
        screenHeight: height,
        userAgent: navigator.userAgent,
        platform: navigator.platform || '',
        isMobile: isMobile,
        isTablet: isTablet,
        isSlowConnection: isSlowConnection,
        effectiveType: effectiveType,
        isHighPerf: !isMobile && !isSlowConnection && width > 1024
      };
    },

    // Container ID finder
    findContainerId(element) {
      let container = element;
      while (container && !container.id) {
        container = container.parentElement;
        if (!container) break;
      }
      return container?.id || null;
    },

    // Affiliate ID detection
    getAffiliateId() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('aff') || urlParams.get('ref') || urlParams.get('aff_id') || 'direct';
    },

    // Debounce function
    debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    },

    // Throttle function
    throttle(func, limit) {
      let inThrottle;
      return function(...args) {
        if (!inThrottle) {
          func.apply(this, args);
          inThrottle = true;
          setTimeout(() => inThrottle = false, limit);
        }
      };
    },

    // Random ID generator
    generateId(prefix = 'dorik') {
      return `${prefix}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    },

    // Safe JSON parse
    safeJsonParse(str, defaultValue = null) {
      try {
        return JSON.parse(str);
      } catch (e) {
        this.error('JSON parse error:', e);
        return defaultValue;
      }
    },

    // Dynamic CSS loader
    loadCSS(url, id = null) {
      return new Promise((resolve, reject) => {
        if (id && document.getElementById(id)) {
          resolve();
          return;
        }
        
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = url;
        if (id) link.id = id;
        
        link.onload = () => {
          this.log('‚úÖ CSS loaded:', url);
          resolve();
        };
        link.onerror = () => {
          this.error('‚ùå CSS failed:', url);
          reject(new Error(`Failed to load CSS: ${url}`));
        };
        
        document.head.appendChild(link);
      });
    },

    // Dynamic JS loader
    loadJS(url, id = null) {
      return new Promise((resolve, reject) => {
        if (id && document.getElementById(id)) {
          resolve();
          return;
        }
        
        const script = document.createElement('script');
        script.src = url;
        if (id) script.id = id;
        
        script.onload = () => {
          this.log('‚úÖ JS loaded:', url);
          resolve();
        };
        script.onerror = () => {
          this.error('‚ùå JS failed:', url);
          reject(new Error(`Failed to load JS: ${url}`));
        };
        
        document.head.appendChild(script);
      });
    },

    // Wait for condition
    waitFor(condition, timeout = 5000, interval = 100) {
      return new Promise((resolve, reject) => {
        const startTime = Date.now();
        
        const check = () => {
          if (condition()) {
            resolve();
          } else if (Date.now() - startTime > timeout) {
            reject(new Error('Timeout waiting for condition'));
          } else {
            setTimeout(check, interval);
          }
        };
        
        check();
      });
    },

    // Logger with debug flag
    log(...args) {
      if (window.DorikConfig?.DEBUG) {
        console.log('[Dorik]', ...args);
      }
    },

    // Error logger
    error(...args) {
      console.error('[Dorik Error]', ...args);
    },

    // Performance marker
    mark(name) {
      if (performance && performance.mark) {
        performance.mark(name);
      }
    },

    // Performance measure
    measure(name, startMark, endMark) {
      if (performance && performance.measure) {
        performance.measure(name, startMark, endMark);
        if (window.DorikConfig?.DEBUG) {
          const measures = performance.getEntriesByName(name);
          if (measures.length > 0) {
            console.log(`‚è±Ô∏è ${name}: ${measures[0].duration.toFixed(2)}ms`);
          }
        }
      }
    },

    // Memory info getter
    getMemoryInfo() {
      if (!performance.memory) return null;
      
      return {
        used_mb: Math.round(performance.memory.usedJSHeapSize / 1024 / 1024),
        total_mb: Math.round(performance.memory.totalJSHeapSize / 1024 / 1024),
        limit_mb: Math.round(performance.memory.jsHeapSizeLimit / 1024 / 1024)
      };
    },

    // Format file size
    formatBytes(bytes, decimals = 2) {
      if (bytes === 0) return '0 Bytes';
      
      const k = 1024;
      const dm = decimals < 0 ? 0 : decimals;
      const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
      
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      
      return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    },

    // Get distance from viewport
    getDistanceFromViewport(element) {
      const rect = element.getBoundingClientRect();
      const viewportHeight = window.innerHeight;
      
      if (rect.top >= 0 && rect.top <= viewportHeight) {
        return 0; // In viewport
      } else if (rect.top > viewportHeight) {
        return rect.top - viewportHeight; // Below viewport
      } else {
        return Math.abs(rect.bottom); // Above viewport
      }
    },

    // Check if element is in viewport
    isInViewport(element, margin = 0) {
      const rect = element.getBoundingClientRect();
      return (
        rect.top >= -margin &&
        rect.left >= -margin &&
        rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) + margin &&
        rect.right <= (window.innerWidth || document.documentElement.clientWidth) + margin
      );
    },

    // Smooth scroll to element
    scrollToElement(element, offset = 0, behavior = 'smooth') {
      const elementPosition = element.getBoundingClientRect().top;
      const offsetPosition = elementPosition + window.pageYOffset - offset;
      
      window.scrollTo({
        top: offsetPosition,
        behavior: behavior
      });
    }
  };

  // === GLOBAL STATE MANAGEMENT ===
  window.DorikState = {
    initialized: false,
    deviceInfo: null,
    processedContainers: new Set(),
    pendingRequests: new Map(),
    observers: {
      intersection: null,
      mutation: null
    },
    timers: {
      cleanup: null,
      performance: null
    },
    counters: {
      galleryViews: 0,
      orderClicks: 0,
      platformClicks: 0,
      cacheHits: 0,
      cacheMisses: 0,
      lazyLoaded: 0,
      trackingEvents: 0
    },
    flags: {
      lightGalleryLoaded: false,
      tallyLoaded: false,
      firebaseReady: false,
      trackingReady: false
    }
  };

  // === RESOURCE HINTS SETUP ===
  function addResourceHints() {
    const domains = [
      'cdnjs.cloudflare.com',
      'tally.so',
      'www.gstatic.com',
      'script.google.com'
    ];
    
    domains.forEach(domain => {
      const link = document.createElement('link');
      link.rel = 'dns-prefetch';
      link.href = `//${domain}`;
      document.head.appendChild(link);
    });
    
    const preconnectDomains = ['cdnjs.cloudflare.com', 'tally.so'];
    preconnectDomains.forEach(domain => {
      const link = document.createElement('link');
      link.rel = 'preconnect';
      link.href = `https://${domain}`;
      document.head.appendChild(link);
    });
  }

  // === INITIALIZATION ===
  function init() {
    // Get device info
    window.DorikState.deviceInfo = window.DorikUtils.getDeviceInfo();
    
    // Setup resource hints
    addResourceHints();
    
    // Mark as initialized
    window.DorikState.initialized = true;
    
    window.DorikUtils.log('‚úÖ Config module loaded');
    window.DorikUtils.log('üì± Device:', window.DorikState.deviceInfo.device, window.DorikState.deviceInfo.os);
  }

  // Auto-initialize
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

})();
