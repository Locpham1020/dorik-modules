/**
 * CONFIG.MIN.JS - Main Configuration Module
 * Central configuration và utility functions
 */

(function() {
  'use strict';

  // === MAIN CONFIGURATION ===
  window.DorikConfig = {
    // API Endpoints
    GOOGLE_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbylfd_DbjRrq90t0jIDPnjx523WhVzXxF9WtajANBLWyVqqZDqZhKu8z6_GOZ6rf9jTQw/exec',
    TALLY_FORM_ID: '31xoq1',
    
    // Performance Settings
    VIEWPORT_MARGIN: '100px',
    BATCH_SIZE: 30,
    SCROLL_DEBOUNCE: 100,
    FIREBASE_TIMEOUT: 5000,
    FIREBASE_RETRY_ATTEMPTS: 3,
    FIREBASE_RETRY_DELAY: 1000,
    
    // Cache Settings
    MAX_PRODUCT_CACHE: 100,
    MAX_IMAGE_CACHE: 200,
    MAX_MEMORY_MB: 50,
    CLEANUP_INTERVAL: 180000,
    
    // Feature Flags
    PRELOAD_NEXT_ONLY: true,
    DEBUG: true,
    
    // CDN URLs
    CDN_BASE: 'https://locpham1020.github.io/dorik-modules/',
    LIGHTGALLERY_CSS: 'https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lightgallery.min.css',
    LIGHTGALLERY_THUMB_CSS: 'https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lg-thumbnail.min.css',
    LIGHTGALLERY_JS: 'https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/lightgallery.min.js',
    LIGHTGALLERY_THUMB_JS: 'https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/plugins/thumbnail/lg-thumbnail.min.js',
    FIREBASE_APP: 'https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js',
    FIREBASE_DB: 'https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js',
    TALLY_SCRIPT: 'https://tally.so/widgets/embed.js'
  };

  // === UTILITY FUNCTIONS ===
  window.DorikUtils = {
    
    // Device Detection
    getDeviceInfo() {
      const width = window.innerWidth;
      const height = window.innerHeight;
      const userAgent = navigator.userAgent.toLowerCase();
      const platform = navigator.platform?.toLowerCase() || '';
      
      const isMobile = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(userAgent) || width <= 768;
      const isTablet = (width > 768 && width <= 1024) || /ipad/i.test(userAgent);
      
      let deviceType = 'desktop';
      if (isMobile && width < 768) deviceType = 'mobile';
      else if (isTablet) deviceType = 'tablet';
      else if (width > 1024 && width <= 1440) deviceType = 'laptop';
      
      const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
      const effectiveType = connection?.effectiveType || '4g';
      const isSlowConnection = ['slow-2g', '2g', '3g'].includes(effectiveType);
      
      let os = 'Unknown';
      if (/iphone/i.test(userAgent)) os = 'iOS';
      else if (/ipad/i.test(userAgent)) os = 'iPadOS';
      else if (/android/i.test(userAgent)) os = 'Android';
      else if (/windows/i.test(userAgent)) os = 'Windows';
      else if (/macintosh|mac os x/i.test(userAgent)) os = 'macOS';
      else if (/linux/i.test(userAgent) && !/android/i.test(userAgent)) os = 'Linux';
      else if (/cros/i.test(userAgent)) os = 'ChromeOS';
      
      return {
        device: deviceType,
        os: os,
        screenWidth: width,
        screenHeight: height,
        userAgent: navigator.userAgent,
        platform: navigator.platform || '',
        isMobile: isMobile,
        isTablet: isTablet,
        isSlowConnection: isSlowConnection,
        effectiveType: effectiveType,
        isHighPerf: !isMobile && !isSlowConnection && width > 1024
      };
    },

    // Container ID finder
    findContainerId(element) {
      let container = element;
      while (container && !container.id) {
        container = container.parentElement;
        if (!container) break;
      }
      return container?.id || null;
    },

    // Affiliate ID detection
    getAffiliateId() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('aff') || urlParams.get('ref') || urlParams.get('aff_id') || 'direct';
    },

    // Debounce function
    debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    },

    // Throttle function
    throttle(func, limit) {
      let inThrottle;
      return function(...args) {
        if (!inThrottle) {
          func.apply(this, args);
          inThrottle = true;
          setTimeout(() => inThrottle = false, limit);
        }
      };
    },

    // Random ID generator
    generateId(prefix = 'dorik') {
      return `${prefix}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    },

    // Safe JSON parse
    safeJsonParse(str, defaultValue = null) {
      try {
        return JSON.parse(str);
      } catch (e) {
        console.warn('JSON parse error:', e);
        return defaultValue;
      }
    },

    // Load CSS dynamically
    loadCSS(url, id = null) {
      return new Promise((resolve, reject) => {
        if (id && document.getElementById(id)) {
          resolve();
          return;
        }
        
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = url;
        if (id) link.id = id;
        
        link.onload = () => resolve();
        link.onerror = () => reject(new Error(`Failed to load CSS: ${url}`));
        
        document.head.appendChild(link);
      });
    },

    // Load JS dynamically
    loadJS(url, id = null) {
      return new Promise((resolve, reject) => {
        if (id && document.getElementById(id)) {
          resolve();
          return;
        }
        
        const script = document.createElement('script');
        script.src = url;
        if (id) script.id = id;
        
        script.onload = () => resolve();
        script.onerror = () => reject(new Error(`Failed to load JS: ${url}`));
        
        document.head.appendChild(script);
      });
    },

    // Logger with debug flag
    log(...args) {
      if (window.DorikConfig?.DEBUG) {
        console.log('[Dorik]', ...args);
      }
    },

    // Error logger
    error(...args) {
      console.error('[Dorik Error]', ...args);
    },

    // Performance marker
    mark(name) {
      if (performance && performance.mark) {
        performance.mark(name);
      }
    },

    // Performance measure
    measure(name, startMark, endMark) {
      if (performance && performance.measure) {
        performance.measure(name, startMark, endMark);
        if (window.DorikConfig?.DEBUG) {
          const measures = performance.getEntriesByName(name);
          if (measures.length > 0) {
            console.log(`⏱️ ${name}: ${measures[0].duration.toFixed(2)}ms`);
          }
        }
      }
    }
  };

  // === GLOBAL STATE ===
  window.DorikState = {
    initialized: false,
    deviceInfo: null,
    processedContainers: new Set(),
    pendingRequests: new Map(),
    observers: {
      intersection: null,
      mutation: null
    },
    timers: {
      cleanup: null,
      performance: null
    },
    counters: {
      galleryViews: 0,
      orderClicks: 0,
      platformClicks: 0,
      cacheHits: 0,
      cacheMisses: 0
    }
  };

  // === INITIALIZATION ===
  window.DorikUtils.log('✅ Config module loaded');

})();
