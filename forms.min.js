/**
 * FORMS.MIN.JS - Tally Forms & Branding Removal Module
 * Order form management v·ªõi auto-hide branding v√† tracking
 */

(function() {
  'use strict';

  // === FORMS MANAGER ===
  window.DorikForms = {
    
    activeForms: new Set(),
    brandingObserver: null,
    loadPromise: null,

    // Initialize forms system
    async init() {
      window.DorikUtils?.log('üõí Initializing forms system...');
      
      // Setup branding removal system
      this.setupBrandingRemoval();
      
      // Tally will be loaded on-demand
      
      window.DorikUtils?.log('‚úÖ Forms system ready (on-demand loading)');
    },

    // Handle order button clicks
    async handleOrderClick(target, containerId) {
      if (!containerId) {
        window.DorikUtils?.error('‚ùå Container ID required for order');
        return;
      }

      try {
        window.DorikUtils?.log(`üõí Processing order: ${containerId}`);
        
        // Show loading state
        this.showLoadingState(target);

        // Track order click FIRST (before opening form)
        if (window.DorikTracking?.trackEvent) {
          window.DorikTracking.trackEvent('order', {
            container_id: containerId,
            platform: 'tally_form'
          });
        }

        // Load Tally if needed
        await this.ensureTallyLoaded();

        // Get product data for pre-filling
        const productData = await this.getProductData(containerId);
        
        // Prepare form data
        const formData = this.prepareFormData(containerId, productData);
        
        // Open Tally form
        this.openTallyForm(formData);

        // Update counter
        if (window.DorikState) {
          window.DorikState.counters.orderClicks++;
        }

      } catch (error) {
        window.DorikUtils?.error('‚ùå Order form error:', error);
        this.showErrorState(target);
        
        // Fallback: Try to open form in new tab
        this.openTallyFallback(containerId);
      } finally {
        this.hideLoadingState(target);
      }
    },

    // Ensure Tally is loaded
    async ensureTallyLoaded() {
      // Prevent multiple loading attempts
      if (this.loadPromise) {
        return this.loadPromise;
      }

      if (window.DorikState?.flags.tallyLoaded) {
        return;
      }

      this.loadPromise = this._loadTally();
      return this.loadPromise;
    },

    async _loadTally() {
      const config = window.DorikConfig;
      if (!config) {
        throw new Error('DorikConfig not found');
      }

      try {
        window.DorikUtils?.log('üì¶ Loading Tally...');
        
        // Load Tally script
        await window.DorikUtils.loadJS(config.TALLY_SCRIPT, 'tally-js');
        
        // Wait for Tally to be ready
        await window.DorikUtils.waitFor(() => window.Tally, 5000);
        
        // Update global state
        if (window.DorikState) {
          window.DorikState.flags.tallyLoaded = true;
        }
        
        window.DorikUtils?.log('‚úÖ Tally loaded');

      } catch (error) {
        this.loadPromise = null; // Reset for retry
        throw new Error('Failed to load Tally: ' + error.message);
      }
    },

    // Get product data
    async getProductData(containerId) {
      if (window.DorikFirebase?.fetchProductData) {
        try {
          return await window.DorikFirebase.fetchProductData(containerId);
        } catch (error) {
          window.DorikUtils?.error('Failed to fetch product data:', error);
        }
      }
      
      // Fallback: get from cache only
      if (window.DorikCache?.getProduct) {
        return window.DorikCache.getProduct(containerId);
      }
      
      return null;
    },

    // Prepare form data for pre-filling
    prepareFormData(containerId, productData) {
      const deviceInfo = window.DorikState?.deviceInfo || window.DorikUtils?.getDeviceInfo();
      const affiliateId = window.DorikUtils?.getAffiliateId();
      
      const formData = {
        container_id: containerId,
        affiliate_id: affiliateId,
        device_type: deviceInfo?.device || 'unknown',
        os: deviceInfo?.os || 'unknown',
        screen_resolution: deviceInfo ? `${deviceInfo.screenWidth}x${deviceInfo.screenHeight}` : 'unknown',
        user_agent: deviceInfo?.userAgent || navigator.userAgent,
        timestamp: new Date().toISOString(),
        page_url: window.location.href,
        referrer: document.referrer || 'direct'
      };

      // Add product data if available
      if (productData) {
        formData.product_name = productData.name || '';
        formData.product_price = productData.price || '';
        formData.product_image = productData.img_main || '';
        formData.product_category = productData.category || '';
      }

      window.DorikUtils?.log('üìã Form data prepared:', formData);
      return formData;
    },

    // Open Tally form with data
    openTallyForm(formData) {
      const config = window.DorikConfig;
      if (!config.TALLY_FORM_ID) {
        throw new Error('Tally form ID not configured');
      }

      try {
        window.DorikUtils?.log('üîÑ Opening Tally form...');
        
        // Get device-specific settings
        const deviceInfo = window.DorikState?.deviceInfo;
        const formSettings = this.getTallyFormSettings(deviceInfo);
        
        // Open form in popup
        window.Tally.openPopup(config.TALLY_FORM_ID, {
          ...formSettings,
          hiddenFields: formData
        });

        // Track form opened
        this.activeForms.add(config.TALLY_FORM_ID);
        
        window.DorikUtils?.log('‚úÖ Tally form opened');

      } catch (error) {
        throw new Error('Failed to open Tally form: ' + error.message);
      }
    },

    // Get device-specific Tally form settings
    getTallyFormSettings(deviceInfo) {
      const baseSettings = {
        layout: 'modal',
        width: 600,
        autoClose: 5000,
        hideTitle: false,
        overlay: true,
        emoji: {
          text: 'üõí',
          animation: 'wave'
        }
      };

      // Mobile adjustments
      if (deviceInfo?.isMobile) {
        baseSettings.width = '95%';
        baseSettings.autoClose = 3000;
      }

      return baseSettings;
    },

    // Fallback: Open in new tab
    openTallyFallback(containerId) {
      window.DorikUtils?.log('üîÑ Using Tally fallback (new tab)...');
      
      const config = window.DorikConfig;
      const formData = this.prepareFormData(containerId, null);
      const params = new URLSearchParams(formData);
      const url = `https://tally.so/r/${config.TALLY_FORM_ID}?${params.toString()}`;
      
      window.open(url, '_blank');
      window.DorikUtils?.log('‚úÖ Tally form opened in new tab');
    },

    // Setup automatic branding removal
    setupBrandingRemoval() {
      // Inject CSS for branding removal
      this.injectBrandingCSS();
      
      // Create observer to watch for Tally elements
      this.brandingObserver = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          mutation.addedNodes.forEach((node) => {
            if (node.nodeType === Node.ELEMENT_NODE) {
              this.removeTallyBranding(node);
            }
          });
        });
      });

      // Start observing
      this.brandingObserver.observe(document.body, {
        childList: true,
        subtree: true
      });

      // Also check existing elements
      this.removeTallyBranding(document.body);
      
      // Interval checker for dynamic content
      setInterval(() => {
        this.removeTallyBranding(document.body);
      }, 1000);
      
      window.DorikUtils?.log('üßπ Branding removal active');
    },

    // Inject CSS for branding removal
    injectBrandingCSS() {
      const css = `
        /* === TALLY BRANDING REMOVAL === */
        .tally-branding,
        .tally-logo,
        .tally-footer,
        .powered-by-tally,
        [data-testid="tally-branding"],
        [data-testid="tally-logo"],
        [data-testid="powered-by-tally"] {
          display: none !important;
          visibility: hidden !important;
          opacity: 0 !important;
          height: 0 !important;
          overflow: hidden !important;
          position: absolute !important;
          left: -9999px !important;
        }
        
        /* Tally links outside form content */
        a[href*="tally.so"]:not(.tally-form a):not([data-tally-form]) {
          display: none !important;
          visibility: hidden !important;
        }
        
        /* Purple header/banner removal */
        .tally-popup .tally-header,
        .tally-modal .tally-header,
        [class*="tally"][class*="header"],
        [style*="background-color: rgb(139, 92, 246)"],
        [style*="background-color: #8b5cf6"],
        [style*="background: rgb(139, 92, 246)"],
        [style*="background: #8b5cf6"] {
          display: none !important;
          height: 0 !important;
        }
        
        /* Any element with purple Tally color */
        [style*="color: rgb(139, 92, 246)"],
        [style*="color: #8b5cf6"] {
          color: transparent !important;
        }
        
        /* Custom overlay for logo area */
        .tally-popup::after {
          content: '';
          position: absolute;
          bottom: 0;
          left: 0;
          right: 0;
          height: 50px;
          background: #393f45 !important;
          pointer-events: none;
          z-index: 10;
        }
        
        /* Ensure form content is visible */
        .tally-form {
          position: relative !important;
          z-index: 5 !important;
        }
        
        /* iframe styling */
        iframe[src*="tally.so"] {
          border: none !important;
          border-radius: 12px !important;
          box-shadow: 0 20px 60px rgba(0,0,0,0.3) !important;
        }
        
        /* Mobile responsive */
        @media (max-width: 768px) {
          iframe[src*="tally.so"] {
            width: 95% !important;
            height: 85% !important;
            border-radius: 8px !important;
          }
          .tally-popup::after {
            height: 40px !important;
          }
        }
      `;
      
      const style = document.createElement('style');
      style.id = 'dorik-tally-branding-removal';
      style.textContent = css;
      document.head.appendChild(style);
      
      window.DorikUtils?.log('‚úÖ Branding removal CSS injected');
    },

    // Remove Tally branding from element and children
    removeTallyBranding(element) {
      if (!element || !element.querySelectorAll) {
        return;
      }

      // Selectors for Tally branding elements
      const brandingSelectors = [
        '.tally-branding',
        '.tally-logo', 
        '[data-testid="tally-branding"]',
        '[data-testid="tally-logo"]',
        '.tally-footer',
        '.powered-by-tally',
        'a[href*="tally.so"]:not(.tally-form a)',
        '[class*="branding"]:not(.tally-form)',
        '[class*="powered"]:not(.tally-form)',
        '[class*="logo"]:not(.tally-form)'
      ];

      brandingSelectors.forEach(selector => {
        try {
          const elements = element.querySelectorAll(selector);
          elements.forEach(el => {
            // Multiple hiding methods for reliability
            el.style.display = 'none';
            el.style.visibility = 'hidden';
            el.style.opacity = '0';
            el.style.height = '0';
            el.style.overflow = 'hidden';
            el.style.position = 'absolute';
            el.style.left = '-9999px';
            el.setAttribute('hidden', '');
            
            // Also try removing the element
            if (el.parentNode) {
              try {
                el.parentNode.removeChild(el);
              } catch (removeError) {
                // Silent fail for removal
              }
            }
          });
        } catch (selectorError) {
          // Silent fail for invalid selectors
        }
      });
    },

    // Loading states
    showLoadingState(element) {
      if (!element) return;
      
      element.classList.add('dorik-loading');
      element.style.pointerEvents = 'none';
      element.style.opacity = '0.7';
      
      // Add loading text if it's a button
      if (element.tagName === 'BUTTON' || element.getAttribute('role') === 'button') {
        element.dataset.originalText = element.textContent;
        element.textContent = 'ƒêang t·∫£i...';
      }
    },

    hideLoadingState(element) {
      if (!element) return;
      
      element.classList.remove('dorik-loading');
      element.style.pointerEvents = '';
      element.style.opacity = '';
      
      // Restore original text
      if (element.dataset.originalText) {
        element.textContent = element.dataset.originalText;
        delete element.dataset.originalText;
      }
    },

    showErrorState(element) {
      if (!element) return;
      
      // Show error message temporarily
      if (element.tagName === 'BUTTON' || element.getAttribute('role') === 'button') {
        const originalText = element.textContent;
        element.textContent = 'L·ªói, th·ª≠ l·∫°i';
        element.style.backgroundColor = '#ef4444';
        element.style.color = 'white';
        
        setTimeout(() => {
          element.textContent = originalText;
          element.style.backgroundColor = '';
          element.style.color = '';
        }, 2000);
      }
      
      window.DorikUtils?.error('Form failed to load');
    },

    // Manual form opener (for testing)
    async openOrderForm(containerId) {
      window.DorikUtils?.log(`üß™ Manual order form: ${containerId}`);
      
      try {
        await this.ensureTallyLoaded();
        const productData = await this.getProductData(containerId);
        const formData = this.prepareFormData(containerId, productData);
        this.openTallyForm(formData);
        
      } catch (error) {
        window.DorikUtils?.error('‚ùå Manual form error:', error);
        this.openTallyFallback(containerId);
      }
    },

    // Forms stats
    getStats() {
      return {
        tallyLoaded: window.DorikState?.flags.tallyLoaded || false,
        activeForms: this.activeForms.size,
        totalOrders: window.DorikState?.counters.orderClicks || 0,
        isLoading: !!this.loadPromise
      };
    },

    // Cleanup
    cleanup() {
      if (this.brandingObserver) {
        this.brandingObserver.disconnect();
        this.brandingObserver = null;
      }
      
      this.activeForms.clear();
      this.loadPromise = null;
      
      // Remove branding CSS
      const brandingCSS = document.getElementById('dorik-tally-branding-removal');
      if (brandingCSS) {
        brandingCSS.remove();
      }
      
      if (window.DorikState) {
        window.DorikState.flags.tallyLoaded = false;
      }
      
      window.DorikUtils?.log('üßπ Forms system cleaned up');
    }
  };

  window.DorikUtils?.log('‚úÖ Forms module loaded');

})();
