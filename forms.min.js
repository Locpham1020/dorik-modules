/**
 * FORMS.MIN.JS - Tally Forms Handler
 * Order form management vá»›i auto-hide branding vÃ  tracking
 */

(function() {
  'use strict';

  // === FORMS MANAGER ===
  window.DorikForms = {
    
    tallyLoaded: false,
    activeForms: new Set(),
    brandingObserver: null,

    // Initialize forms system
    async init() {
      // Setup event listeners for order buttons
      this.setupEventListeners();
      
      // Setup branding removal system
      this.setupBrandingRemoval();
      
      window.DorikUtils?.log('âœ… Forms system initialized');
    },

    // Setup click event listeners
    setupEventListeners() {
      // Use event delegation for order buttons
      document.addEventListener('click', this.handleOrderClick.bind(this));
    },

    // Handle order button clicks
    async handleOrderClick(event) {
      const target = event.target;
      
      // Check if clicked element is order button
      const isOrderButton = target.hasAttribute('data-field') && target.getAttribute('data-field') === 'order';
      
      if (!isOrderButton) {
        return;
      }

      event.preventDefault();
      event.stopPropagation();

      // Get container ID
      const containerId = window.DorikUtils?.findContainerId(target);
      if (!containerId) {
        window.DorikUtils?.error('Container ID not found for order');
        return;
      }

      // Track order click first (before opening form)
      if (window.DorikTracking?.trackEvent) {
        window.DorikTracking.trackEvent('order', {
          container_id: containerId,
          platform: 'tally_form'
        });
      }

      // Update counter
      if (window.DorikState) {
        window.DorikState.counters.orderClicks++;
      }

      // Open order form
      await this.openOrderForm(containerId, target);
    },

    // Open Tally order form
    async openOrderForm(containerId, triggerElement) {
      try {
        // Show loading state
        this.showLoadingState(triggerElement);

        // Load Tally if not loaded
        await this.ensureTallyLoaded();

        // Get product data for pre-filling
        const productData = await this.getProductData(containerId);
        
        // Prepare form data
        const formData = this.prepareFormData(containerId, productData);
        
        // Open Tally form
        this.openTallyForm(formData);

      } catch (error) {
        window.DorikUtils?.error('Order form error:', error);
        this.showErrorState(triggerElement);
      } finally {
        this.hideLoadingState(triggerElement);
      }
    },

    // Ensure Tally is loaded
    async ensureTallyLoaded() {
      if (this.tallyLoaded) {
        return;
      }

      const config = window.DorikConfig;
      if (!config) {
        throw new Error('DorikConfig not found');
      }

      try {
        // Load Tally script
        await window.DorikUtils.loadJS(config.TALLY_SCRIPT, 'tally-js');
        
        // Wait for Tally to be ready
        await this.waitForTally();
        
        this.tallyLoaded = true;
        window.DorikUtils?.log('âœ… Tally loaded');

      } catch (error) {
        throw new Error('Failed to load Tally: ' + error.message);
      }
    },

    // Wait for Tally to be available
    waitForTally(maxWait = 5000) {
      return new Promise((resolve, reject) => {
        const startTime = Date.now();
        
        const checkTally = () => {
          if (window.Tally) {
            resolve();
          } else if (Date.now() - startTime > maxWait) {
            reject(new Error('Tally loading timeout'));
          } else {
            setTimeout(checkTally, 100);
          }
        };
        
        checkTally();
      });
    },

    // Get product data
    async getProductData(containerId) {
      if (window.DorikFirebase?.fetchProductData) {
        try {
          return await window.DorikFirebase.fetchProductData(containerId);
        } catch (error) {
          window.DorikUtils?.error('Failed to fetch product data:', error);
        }
      }
      
      // Fallback: get from cache only
      return window.DorikCache?.getProduct(containerId) || null;
    },

    // Prepare form data for pre-filling
    prepareFormData(containerId, productData) {
      const deviceInfo = window.DorikState?.deviceInfo || window.DorikUtils?.getDeviceInfo();
      const affiliateId = window.DorikUtils?.getAffiliateId();
      
      const formData = {
        container_id: containerId,
        affiliate_id: affiliateId,
        device_type: deviceInfo?.device || 'unknown',
        os: deviceInfo?.os || 'unknown',
        screen_resolution: deviceInfo ? `${deviceInfo.screenWidth}x${deviceInfo.screenHeight}` : 'unknown',
        user_agent: deviceInfo?.userAgent || navigator.userAgent,
        timestamp: new Date().toISOString(),
        page_url: window.location.href,
        referrer: document.referrer || 'direct'
      };

      // Add product data if available
      if (productData) {
        formData.product_name = productData.name || '';
        formData.product_price = productData.price || '';
        formData.product_image = productData.img_main || '';
      }

      return formData;
    },

    // Open Tally form with data
    openTallyForm(formData) {
      const config = window.DorikConfig;
      if (!config.TALLY_FORM_ID) {
        throw new Error('Tally form ID not configured');
      }

      try {
        // Build form URL with pre-filled data
        const formUrl = this.buildTallyUrl(config.TALLY_FORM_ID, formData);
        
        // Open form in popup
        window.Tally.openPopup(config.TALLY_FORM_ID, {
          layout: 'modal',
          width: 600,
          autoClose: 5000,
          hideTitle: false,
          overlay: true,
          emoji: {
            text: 'ðŸ›’',
            animation: 'wave'
          },
          // Pass form data
          hiddenFields: formData
        });

        // Track form opened
        this.activeForms.add(config.TALLY_FORM_ID);
        
        window.DorikUtils?.log('âœ… Tally form opened:', config.TALLY_FORM_ID);

      } catch (error) {
        throw new Error('Failed to open Tally form: ' + error.message);
      }
    },

    // Build Tally URL with parameters
    buildTallyUrl(formId, data) {
      const baseUrl = `https://tally.so/r/${formId}`;
      const params = new URLSearchParams();
      
      // Add each data field as parameter
      Object.entries(data).forEach(([key, value]) => {
        if (value !== null && value !== undefined && value !== '') {
          params.append(key, String(value));
        }
      });
      
      return params.toString() ? `${baseUrl}?${params.toString()}` : baseUrl;
    },

    // Setup automatic branding removal
    setupBrandingRemoval() {
      // Create observer to watch for Tally elements
      this.brandingObserver = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          mutation.addedNodes.forEach((node) => {
            if (node.nodeType === Node.ELEMENT_NODE) {
              this.removeTallyBranding(node);
            }
          });
        });
      });

      // Start observing
      this.brandingObserver.observe(document.body, {
        childList: true,
        subtree: true
      });

      // Also check existing elements
      this.removeTallyBranding(document.body);
    },

    // Remove Tally branding from element and children
    removeTallyBranding(element) {
      if (!element || !element.querySelectorAll) {
        return;
      }

      // Selectors for Tally branding elements
      const brandingSelectors = [
        '.tally-branding',
        '.tally-logo', 
        '[data-testid="tally-branding"]',
        '[data-testid="tally-logo"]',
        '.tally-footer',
        '.powered-by-tally',
        'a[href*="tally.so"]:not(.tally-form a)',
        '[class*="branding"]:not(.tally-form)',
        '[class*="powered"]:not(.tally-form)',
        '[class*="logo"]:not(.tally-form)'
      ];

      brandingSelectors.forEach(selector => {
        try {
          const elements = element.querySelectorAll(selector);
          elements.forEach(el => {
            // Multiple hiding methods for reliability
            el.style.display = 'none';
            el.style.visibility = 'hidden';
            el.style.opacity = '0';
            el.style.height = '0';
            el.style.overflow = 'hidden';
            el.setAttribute('hidden', '');
            
            // Also try removing the element
            if (el.parentNode) {
              try {
                el.parentNode.removeChild(el);
              } catch (removeError) {
                // Silent fail for removal
              }
            }
          });
        } catch (selectorError) {
          // Silent fail for invalid selectors
        }
      });
    },

    // Loading states
    showLoadingState(element) {
      element.classList.add('dorik-loading');
      element.style.pointerEvents = 'none';
      
      // Add loading text if it's a button
      if (element.tagName === 'BUTTON' || element.getAttribute('role') === 'button') {
        element.dataset.originalText = element.textContent;
        element.textContent = 'Äang táº£i...';
      }
    },

    hideLoadingState(element) {
      element.classList.remove('dorik-loading');
      element.style.pointerEvents = '';
      
      // Restore original text
      if (element.dataset.originalText) {
        element.textContent = element.dataset.originalText;
        delete element.dataset.originalText;
      }
    },

    showErrorState(element) {
      // Could add error styling here
      window.DorikUtils?.error('Form failed to load');
      
      // Show error message temporarily
      if (element.tagName === 'BUTTON' || element.getAttribute('role') === 'button') {
        const originalText = element.textContent;
        element.textContent = 'Lá»—i, thá»­ láº¡i';
        element.style.backgroundColor = '#ef4444';
        
        setTimeout(() => {
          element.textContent = originalText;
          element.style.backgroundColor = '';
        }, 2000);
      }
    },

    // Cleanup
    cleanup() {
      if (this.brandingObserver) {
        this.brandingObserver.disconnect();
        this.brandingObserver = null;
      }
      
      this.activeForms.clear();
    },

    // Forms stats
    getStats() {
      return {
        tallyLoaded: this.tallyLoaded,
        activeForms: this.activeForms.size,
        totalOrders: window.DorikState?.counters.orderClicks || 0
      };
    }
  };

  window.DorikUtils?.log('âœ… Forms module loaded');

})();
