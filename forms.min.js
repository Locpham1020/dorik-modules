/**
 * FORMS MODULE - Tally Forms Integration
 * URL: https://yourname.github.io/dorik-modules/forms.min.js
 */

window.DorikForms = (function() {
  'use strict';

  // === FORMS MANAGER ===
  const FormsManager = {
    initialized: false,
    tallyLoaded: false,
    tallyObserver: null,
    
    // Initialize forms system
    async init() {
      if (this.initialized) return;
      
      await this.loadTallyScript();
      this.setupEventListeners();
      this.setupTallyObserver();
      this.initialized = true;
      
      this._log('Forms Manager initialized');
    },

    // Load Tally script
    async loadTallyScript() {
      if (typeof Tally !== 'undefined') {
        this.tallyLoaded = true;
        return true;
      }
      
      try {
        // DNS prefetch
        const prefetch = document.createElement('link');
        prefetch.rel = 'dns-prefetch';
        prefetch.href = 'https://tally.so';
        document.head.appendChild(prefetch);
        
        // Load script
        await this.loadScript('https://tally.so/widgets/embed.js');
        this.tallyLoaded = typeof Tally !== 'undefined';
        
        this._log('Tally script loaded:', this.tallyLoaded);
        return this.tallyLoaded;
        
      } catch (error) {
        console.error('Failed to load Tally script:', error);
        this.tallyLoaded = false;
        return false;
      }
    },

    // Load script helper
    loadScript(src) {
      return new Promise((resolve, reject) => {
        const existing = document.querySelector(`script[src="${src}"]`);
        if (existing) {
          resolve();
          return;
        }
        
        const script = document.createElement('script');
        script.src = src;
        script.async = true;
        script.onload = () => resolve();
        script.onerror = () => reject(new Error(`Failed to load ${src}`));
        document.head.appendChild(script);
      });
    },

    // Setup event listeners
    setupEventListeners() {
      document.addEventListener('click', async (e) => {
        const element = e.target.closest('[data-field="order"]');
        if (!element) return;
        
        e.preventDefault();
        await this.handleOrderClick(element);
      });
    },

    // Handle order button click
    async handleOrderClick(element) {
      const containerId = this.findContainerId(element);
      if (!containerId) {
        console.warn('No container ID found for Order button');
        return;
      }
      
      this._log('Order clicked for container:', containerId);
      
      // Track order click
      if (window.DorikTracking) {
        window.DorikTracking.trackOrder(containerId);
      }
      
      // Open order form
      await this.openOrderForm(containerId);
    },

    // Open order form
    async openOrderForm(containerId) {
      await this.loadTallyScript();
      
      const deviceInfo = this.getDeviceInfo();
      const affiliateId = this.getAffiliateId();
      const config = window.DorikConfig ? window.DorikConfig.getAll() : {};
      
      const formId = config.TALLY_FORM_ID || '31xoq1';
      
      // Prepare hidden fields
      const hiddenFields = {
        container_id: containerId,
        device: deviceInfo.device,
        os: deviceInfo.os,
        affiliate_id: affiliateId,
        screen: deviceInfo.screenWidth + 'x' + deviceInfo.screenHeight,
        mobile: deviceInfo.isMobile ? 'true' : 'false',
        connection: deviceInfo.effectiveType,
        performance: deviceInfo.isHighPerf ? 'high' : 'standard',
        timestamp: new Date().toISOString()
      };
      
      // Try Tally popup first
      if (this.tallyLoaded && typeof Tally !== 'undefined' && typeof Tally.openPopup === 'function') {
        try {
          Tally.openPopup(formId, {
            hiddenFields: hiddenFields,
            width: deviceInfo.isMobile ? Math.min(window.innerWidth - 40, 400) : 540,
            layout: 'modal',
            alignLeft: false,
            emoji: 'ðŸ›’',
            onOpen: () => {
              this._log('Tally popup opened');
            },
            onSubmit: () => {
              this._log('Order form submitted');
              this.trackFormSubmission(containerId);
            },
            onClose: () => {
              this._log('Tally popup closed');
            }
          });
          
          return;
          
        } catch (error) {
          console.error('Error opening Tally popup:', error);
        }
      }
      
      // Fallback to direct URL
      this.openTallyUrl(formId, hiddenFields);
    },

    // Open Tally URL (fallback)
    openTallyUrl(formId, hiddenFields) {
      let tallyUrl = `https://tally.so/r/${formId}?`;
      
      Object.entries(hiddenFields).forEach(([key, value]) => {
        tallyUrl += `${key}=${encodeURIComponent(value)}&`;
      });
      
      // Remove trailing &
      tallyUrl = tallyUrl.slice(0, -1);
      
      this._log('Opening Tally URL:', tallyUrl);
      window.open(tallyUrl, '_blank', 'noopener,noreferrer');
    },

    // Setup Tally observer for logo hiding
    setupTallyObserver() {
      if (this.tallyObserver) {
        this.tallyObserver.disconnect();
      }
      
      this.tallyObserver = new MutationObserver((mutations) => {
        let tallyPopupFound = false;
        
        for (const mutation of mutations) {
          if (mutation.type === 'childList') {
            for (const node of mutation.addedNodes) {
              if (node.nodeType === Node.ELEMENT_NODE) {
                if (node.classList?.contains('tally-popup') || 
                    node.querySelector?.('.tally-popup')) {
                  tallyPopupFound = true;
                  break;
                }
              }
            }
          }
          if (tallyPopupFound) break;
        }
        
        if (tallyPopupFound) {
          this._log('Tally popup detected, hiding logo...');
          // Multiple attempts to ensure logo is hidden
          setTimeout(() => this.hideTallyLogo(), 50);
          setTimeout(() => this.hideTallyLogo(), 200);
          setTimeout(() => this.hideTallyLogo(), 500);
          setTimeout(() => this.hideTallyLogo(), 1000);
        }
      });
      
      this.tallyObserver.observe(document.body, {
        childList: true,
        subtree: true
      });
    },

    // Hide Tally logo and branding
    hideTallyLogo() {
      const logoSelectors = [
        'a[href*="tally.so"]:not(.tally-form a):not(form a)',
        '[class*="branding"]:not(.tally-form *):not(form *)',
        '[class*="powered"]:not(.tally-form *):not(form *)',
        '[class*="logo"]:not(.tally-form *):not(form *)'
      ];
      
      logoSelectors.forEach(selector => {
        const elements = document.querySelectorAll(`.tally-popup ${selector}`);
        elements.forEach(el => {
          if (!el.closest('form') && !el.closest('.tally-form')) {
            el.style.cssText = 'display:none!important;visibility:hidden!important;height:0!important;width:0!important;overflow:hidden!important;opacity:0!important;position:absolute!important;left:-9999px!important;';
          }
        });
      });
      
      // Hide bottom branding elements
      const popup = document.querySelector('.tally-popup');
      if (popup) {
        const bottomElements = popup.querySelectorAll('div:last-child a[href*="tally.so"]');
        bottomElements.forEach(el => {
          if (el.textContent.toLowerCase().includes('tally') || 
              el.innerHTML.includes('logo') || 
              el.parentElement.style.textAlign === 'center') {
            el.style.display = 'none';
          }
        });
      }
    },

    // Track form submission
    trackFormSubmission(containerId) {
      if (window.DorikTracking) {
        window.DorikTracking.send('form_submit', containerId, {
          event_type: 'form_submission',
          form_type: 'order_form',
          timestamp: Date.now()
        });
      }
    },

    // Contact form (if needed for other forms)
    openContactForm(containerId, formType = 'contact') {
      const deviceInfo = this.getDeviceInfo();
      const config = window.DorikConfig ? window.DorikConfig.getAll() : {};
      
      // You can add different form IDs for different purposes
      const formId = config.CONTACT_FORM_ID || config.TALLY_FORM_ID || '31xoq1';
      
      const hiddenFields = {
        container_id: containerId,
        form_type: formType,
        device: deviceInfo.device,
        timestamp: new Date().toISOString()
      };
      
      if (this.tallyLoaded && typeof Tally !== 'undefined') {
        try {
          Tally.openPopup(formId, {
            hiddenFields: hiddenFields,
            width: deviceInfo.isMobile ? Math.min(window.innerWidth - 40, 400) : 540,
            layout: 'modal'
          });
        } catch (error) {
          this.openTallyUrl(formId, hiddenFields);
        }
      } else {
        this.openTallyUrl(formId, hiddenFields);
      }
    },

    // Custom form validation (if needed)
    validateForm(formData) {
      const errors = [];
      
      if (!formData.name || formData.name.trim().length < 2) {
        errors.push('TÃªn pháº£i cÃ³ Ã­t nháº¥t 2 kÃ½ tá»±');
      }
      
      if (!formData.phone || !/^[0-9+\-\s()]{8,15}$/.test(formData.phone)) {
        errors.push('Sá»‘ Ä‘iá»‡n thoáº¡i khÃ´ng há»£p lá»‡');
      }
      
      if (formData.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(formData.email)) {
        errors.push('Email khÃ´ng há»£p lá»‡');
      }
      
      return {
        isValid: errors.length === 0,
        errors: errors
      };
    },

    // Get device info
    getDeviceInfo() {
      if (window.DorikConfig) {
        return window.DorikConfig.Utils.getDeviceInfo();
      }
      
      const width = window.innerWidth;
      return {
        device: width <= 768 ? 'mobile' : 'desktop',
        os: navigator.platform || 'Unknown',
        screenWidth: width,
        screenHeight: window.innerHeight,
        isMobile: width <= 768,
        effectiveType: '4g',
        isHighPerf: width > 1024
      };
    },

    // Get affiliate ID
    getAffiliateId() {
      if (window.DorikConfig) {
        return window.DorikConfig.Utils.getAffiliateId();
      }
      
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('aff') || urlParams.get('ref') || 'direct';
    },

    // Find container ID
    findContainerId(element) {
      if (window.DorikConfig) {
        return window.DorikConfig.Utils.findContainerId(element);
      }
      
      let container = element;
      while (container && !container.id) {
        container = container.parentElement;
        if (!container) break;
      }
      return container?.id || null;
    },

    // Cleanup
    cleanup() {
      if (this.tallyObserver) {
        this.tallyObserver.disconnect();
        this.tallyObserver = null;
      }
    },

    _log(message, data = null) {
      if (window.DorikConfig && window.DorikConfig.Utils) {
        window.DorikConfig.Utils.log(message, data);
      }
    }
  };

  // Cleanup on page unload
  window.addEventListener('beforeunload', () => {
    FormsManager.cleanup();
  });

  // === PUBLIC API ===
  return {
    // Initialize forms
    init: () => FormsManager.init(),
    
    // Form operations
    openOrder: (containerId) => FormsManager.openOrderForm(containerId),
    openContact: (containerId, type) => FormsManager.openContactForm(containerId, type),
    
    // Utilities
    validate: (formData) => FormsManager.validateForm(formData),
    hideLogo: () => FormsManager.hideTallyLogo(),
    
    // Resource management
    loadTally: () => FormsManager.loadTallyScript(),
    
    // Status
    get isInitialized() { return FormsManager.initialized; },
    get isTallyLoaded() { return FormsManager.tallyLoaded; }
  };

})();
