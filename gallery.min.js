/**
 * GALLERY MODULE - Image Gallery System
 * URL: https://yourname.github.io/dorik-modules/gallery.min.js
 */

window.DorikGallery = (function() {
  'use strict';

  // === GALLERY MANAGER ===
  const GalleryManager = {
    initialized: false,
    activeGallery: null,
    resourcesLoaded: false,
    
    // Initialize gallery system
    async init() {
      if (this.initialized) return;
      
      await this.loadResources();
      this.setupEventListeners();
      this.initialized = true;
      
      this._log('Gallery Manager initialized');
    },

    // Load gallery resources
    async loadResources() {
      if (this.resourcesLoaded) return;
      
      const config = window.DorikConfig ? window.DorikConfig.get('CDN') : {};
      
      const resources = [
        { 
          type: 'css', 
          url: config.LIGHTGALLERY_CSS || 'https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lightgallery.min.css' 
        },
        { 
          type: 'css', 
          url: config.LIGHTGALLERY_THUMB_CSS || 'https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lg-thumbnail.min.css' 
        },
        { 
          type: 'js', 
          url: config.LIGHTGALLERY_JS || 'https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/lightgallery.min.js' 
        },
        { 
          type: 'js', 
          url: config.LIGHTGALLERY_THUMB_JS || 'https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/plugins/thumbnail/lg-thumbnail.min.js' 
        }
      ];
      
      try {
        await Promise.all(resources.map(resource => this.loadResource(resource)));
        this.resourcesLoaded = true;
        this._log('Gallery resources loaded successfully');
      } catch (error) {
        console.error('Failed to load gallery resources:', error);
        this.resourcesLoaded = false;
      }
    },

    // Load individual resource
    loadResource(resource) {
      return new Promise((resolve, reject) => {
        const existing = document.querySelector(
          resource.type === 'css' 
            ? `link[href="${resource.url}"]` 
            : `script[src="${resource.url}"]`
        );
        
        if (existing) {
          resolve();
          return;
        }
        
        const element = document.createElement(resource.type === 'css' ? 'link' : 'script');
        
        if (resource.type === 'css') {
          element.rel = 'stylesheet';
          element.href = resource.url;
        } else {
          element.src = resource.url;
          element.async = true;
        }
        
        element.onload = () => resolve();
        element.onerror = () => reject(new Error(`Failed to load ${resource.url}`));
        
        document.head.appendChild(element);
      });
    },

    // Setup event listeners
    setupEventListeners() {
      document.addEventListener('click', async (e) => {
        const element = e.target.closest('[data-field="img_main"], [data-field="see_more"]');
        if (!element) return;
        
        e.preventDefault();
        await this.handleGalleryClick(element);
      });
    },

    // Handle gallery click
    async handleGalleryClick(element) {
      const containerId = this.findContainerId(element);
      if (!containerId) {
        console.warn('No container ID found');
        return;
      }
      
      this._log('üöÄ Opening gallery for:', containerId);
      
      try {
        // Fetch product data
        const productData = await this.fetchProductData(containerId);
        if (!productData) {
          this.showError('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu s·∫£n ph·∫©m');
          return;
        }
        
        // Get prioritized images
        const images = this.getPrioritizedImages(productData);
        if (images.length === 0) {
          this.showError('Kh√¥ng t√¨m th·∫•y h√¨nh ·∫£nh');
          return;
        }
        
        // Open gallery
        await this.openGallery(images);
        
        // Track gallery view
        if (window.DorikTracking) {
          window.DorikTracking.trackGallery(containerId);
        }
        
      } catch (error) {
        console.error('Gallery error:', error);
        this.showError('L·ªói khi m·ªü gallery');
      }
    },

    // Open gallery with images
    async openGallery(images) {
      // Close existing gallery
      if (this.activeGallery) {
        this.closeGallery();
      }
      
      // Ensure resources are loaded
      await this.loadResources();
      
      if (typeof lightGallery !== 'undefined' && this.resourcesLoaded) {
        this.openLightGallery(images);
      } else {
        this.openSimpleGallery(images);
      }
    },

    // Open LightGallery
    openLightGallery(images) {
      let galleryContainer = document.getElementById('dorik-gallery-container');
      if (!galleryContainer) {
        galleryContainer = document.createElement('div');
        galleryContainer.id = 'dorik-gallery-container';
        galleryContainer.style.display = 'none';
        document.body.appendChild(galleryContainer);
      }
      
      const deviceInfo = this.getDeviceInfo();
      
      try {
        this.activeGallery = lightGallery(galleryContainer, {
          dynamic: true,
          dynamicEl: images,
          plugins: window.lgThumbnail ? [lgThumbnail] : [],
          download: false,
          mode: 'lg-fade',
          speed: deviceInfo.isSlowConnection ? 400 : 300,
          backdropDuration: 150,
          mousewheel: true,
          swipeThreshold: deviceInfo.isMobile ? 20 : 30,
          
          // Thumbnail settings
          thumbnail: window.lgThumbnail ? true : false,
          thumbWidth: deviceInfo.isMobile ? 45 : 60,
          thumbHeight: deviceInfo.isMobile ? 45 : 60,
          thumbMargin: 6,
          animateThumb: !deviceInfo.isSlowConnection,
          
          // Enhanced swipe settings
          swipeSpeed: 400,
          enableSwipe: true,
          enableDrag: true,
          
          showCloseIcon: true,
          counter: true,
          controls: true,
          
          // License key to suppress warnings
          licenseKey: '0000-0000-000-0000',
          
          mobileSettings: {
            showCloseIcon: true,
            controls: true,
            swipeThreshold: 15,
            thumbnail: window.lgThumbnail ? true : false,
            thumbWidth: 40,
            thumbHeight: 40,
            swipeSpeed: 300
          },
          
          addClass: 'dorik-gallery-custom'
        });
        
        // Setup close handler
        galleryContainer.addEventListener('lgAfterClose', () => {
          this.closeGallery();
        }, { once: true });
        
        // Open gallery
        this.activeGallery.openGallery(0);
        this._log('LightGallery opened successfully');
        
      } catch (error) {
        console.error('LightGallery error:', error);
        this.openSimpleGallery(images);
      }
    },

    // Open simple gallery (fallback)
    openSimpleGallery(images) {
      const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
      const isDesktop = !isTouchDevice && window.innerWidth > 1024;
      
      // Create modal
      const modal = document.createElement('div');
      modal.className = 'dorik-simple-gallery-modal';
      modal.style.cssText = `
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 100% !important;
        background: rgba(0, 0, 0, 0.95) !important;
        z-index: 999999 !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        flex-direction: column !important;
        opacity: 0 !important;
        transition: opacity 0.3s ease !important;
      `;
      
      let currentIndex = 0;
      
      // Image container
      const imgContainer = document.createElement('div');
      imgContainer.style.cssText = `
        position: relative !important;
        max-width: 90% !important;
        max-height: 80% !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        user-select: none !important;
      `;
      
      // Main image
      const img = document.createElement('img');
      img.style.cssText = `
        max-width: 100% !important;
        max-height: 100% !important;
        object-fit: contain !important;
        border-radius: 8px !important;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1) !important;
        pointer-events: none !important;
      `;
      img.src = images[currentIndex].src;
      img.alt = 'Gallery Image';
      
      // Close button
      const closeBtn = document.createElement('button');
      closeBtn.innerHTML = '‚úï';
      closeBtn.style.cssText = `
        position: absolute !important;
        top: 20px !important;
        right: 20px !important;
        background: rgba(0, 0, 0, 0.7) !important;
        border: none !important;
        color: white !important;
        font-size: 24px !important;
        width: 50px !important;
        height: 50px !important;
        border-radius: 50% !important;
        cursor: pointer !important;
        z-index: 1000001 !important;
        transition: all 0.2s ease !important;
      `;
      
      closeBtn.onclick = () => {
        modal.style.opacity = '0';
        setTimeout(() => {
          if (modal.parentNode) {
            modal.parentNode.removeChild(modal);
          }
          this.activeGallery = null;
        }, 300);
      };
      
      // Counter
      const counter = document.createElement('div');
      counter.style.cssText = `
        position: absolute !important;
        bottom: 20px !important;
        left: 50% !important;
        transform: translateX(-50%) !important;
        background: rgba(0, 0, 0, 0.7) !important;
        color: #ff4444 !important;
        padding: 8px 16px !important;
        border-radius: 20px !important;
        font-family: Arial, sans-serif !important;
        font-size: 14px !important;
        font-weight: bold !important;
        border: 1px solid #ff4444 !important;
      `;
      
      const updateCounter = () => {
        counter.textContent = `${currentIndex + 1} / ${images.length}`;
      };
      updateCounter();
      
      // Navigation for desktop
      if (isDesktop && images.length > 1) {
        const createNavButton = (direction, text, position) => {
          const btn = document.createElement('button');
          btn.innerHTML = text;
          btn.style.cssText = `
            position: absolute !important;
            ${position}: 20px !important;
            top: 50% !important;
            transform: translateY(-50%) !important;
            background: rgba(0, 0, 0, 0.7) !important;
            border: none !important;
            color: white !important;
            font-size: 30px !important;
            width: 60px !important;
            height: 60px !important;
            border-radius: 50% !important;
            cursor: pointer !important;
            opacity: 0.8 !important;
            transition: all 0.2s ease !important;
          `;
          
          btn.onclick = () => {
            if (direction === 'prev') {
              currentIndex = currentIndex > 0 ? currentIndex - 1 : images.length - 1;
            } else {
              currentIndex = currentIndex < images.length - 1 ? currentIndex + 1 : 0;
            }
            img.src = images[currentIndex].src;
            updateCounter();
          };
          
          return btn;
        };
        
        modal.appendChild(createNavButton('prev', '‚Äπ', 'left'));
        modal.appendChild(createNavButton('next', '‚Ä∫', 'right'));
      }
      
      // Touch navigation for mobile
      if (isTouchDevice && images.length > 1) {
        let touchStartX = 0;
        
        imgContainer.addEventListener('touchstart', (e) => {
          touchStartX = e.touches[0].clientX;
        }, { passive: true });
        
        imgContainer.addEventListener('touchend', (e) => {
          const touchEndX = e.changedTouches[0].clientX;
          const deltaX = touchEndX - touchStartX;
          
          if (Math.abs(deltaX) > 50) {
            if (deltaX > 0) {
              // Swipe right - previous
              currentIndex = currentIndex > 0 ? currentIndex - 1 : images.length - 1;
            } else {
              // Swipe left - next
              currentIndex = currentIndex < images.length - 1 ? currentIndex + 1 : 0;
            }
            img.src = images[currentIndex].src;
            updateCounter();
          }
        }, { passive: true });
      }
      
      // Keyboard navigation
      const handleKeydown = (e) => {
        if (e.key === 'Escape') {
          closeBtn.click();
        } else if (e.key === 'ArrowLeft' && images.length > 1) {
          currentIndex = currentIndex > 0 ? currentIndex - 1 : images.length - 1;
          img.src = images[currentIndex].src;
          updateCounter();
        } else if (e.key === 'ArrowRight' && images.length > 1) {
          currentIndex = currentIndex < images.length - 1 ? currentIndex + 1 : 0;
          img.src = images[currentIndex].src;
          updateCounter();
        }
      };
      document.addEventListener('keydown', handleKeydown);
      
      // Assemble modal
      imgContainer.appendChild(img);
      modal.appendChild(imgContainer);
      modal.appendChild(closeBtn);
      modal.appendChild(counter);
      
      // Add to DOM
      document.body.appendChild(modal);
      
      // Fade in
      setTimeout(() => {
        modal.style.opacity = '1';
      }, 10);
      
      // Set as active gallery
      this.activeGallery = {
        destroy: () => {
          document.removeEventListener('keydown', handleKeydown);
          if (modal && modal.parentNode) {
            modal.style.opacity = '0';
            setTimeout(() => {
              if (modal.parentNode) {
                modal.parentNode.removeChild(modal);
              }
            }, 300);
          }
        }
      };
      
      this._log('Simple gallery opened');
    },

    // Close gallery
    closeGallery() {
      if (this.activeGallery) {
        try {
          this.activeGallery.destroy();
        } catch (e) {
          // Silent cleanup
        }
        this.activeGallery = null;
      }
    },

    // Show error message
    showError(message) {
      const errorModal = document.createElement('div');
      errorModal.style.cssText = `
        position: fixed !important;
        top: 50% !important;
        left: 50% !important;
        transform: translate(-50%, -50%) !important;
        background: rgba(0, 0, 0, 0.9) !important;
        color: white !important;
        padding: 30px !important;
        border-radius: 12px !important;
        z-index: 999999 !important;
        text-align: center !important;
        font-family: Arial, sans-serif !important;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5) !important;
      `;
      
      errorModal.innerHTML = `
        <h3 style="margin: 0 0 15px 0; font-size: 18px;">‚ö†Ô∏è ${message}</h3>
        <button onclick="this.parentElement.remove()" style="
          background: #fff !important;
          color: #000 !important;
          border: none !important;
          padding: 10px 20px !important;
          border-radius: 6px !important;
          cursor: pointer !important;
        ">ƒê√≥ng</button>
      `;
      
      document.body.appendChild(errorModal);
      
      // Auto remove after 5 seconds
      setTimeout(() => {
        if (errorModal.parentNode) {
          errorModal.remove();
        }
      }, 5000);
    },

    // Fetch product data
    async fetchProductData(containerId) {
      if (window.DorikFirebase) {
        return await window.DorikFirebase.fetchProduct(containerId);
      }
      
      // Fallback if Firebase module not available
      console.warn('Firebase module not available');
      return null;
    },

    // Get prioritized images
    getPrioritizedImages(productData) {
      if (window.DorikFirebase) {
        return window.DorikFirebase.getPrioritizedImages(productData);
      }
      
      // Fallback image extraction
      const images = [];
      const imageKeys = ['img_main', 'img01', 'img02', 'img03', 'img04', 'img05'];
      
      imageKeys.forEach(key => {
        const imgUrl = productData[key];
        if (imgUrl && typeof imgUrl === 'string' && imgUrl.includes('http')) {
          images.push({
            src: imgUrl,
            thumb: imgUrl
          });
        }
      });
      
      return images;
    },

    // Get device info
    getDeviceInfo() {
      if (window.DorikConfig) {
        return window.DorikConfig.Utils.getDeviceInfo();
      }
      
      return {
        isMobile: window.innerWidth <= 768,
        isSlowConnection: false
      };
    },

    // Find container ID
    findContainerId(element) {
      if (window.DorikConfig) {
        return window.DorikConfig.Utils.findContainerId(element);
      }
      
      let container = element;
      while (container && !container.id) {
        container = container.parentElement;
        if (!container) break;
      }
      return container?.id || null;
    },

    _log(message, data = null) {
      if (window.DorikConfig && window.DorikConfig.Utils) {
        window.DorikConfig.Utils.log(message, data);
      }
    }
  };

  // Cleanup on page unload
  window.addEventListener('beforeunload', () => {
    GalleryManager.closeGallery();
  });

  // === PUBLIC API ===
  return {
    // Initialize gallery
    init: () => GalleryManager.init(),
    
    // Gallery operations
    open: (images) => GalleryManager.openGallery(images),
    close: () => GalleryManager.closeGallery(),
    
    // Resource management
    loadResources: () => GalleryManager.loadResources(),
    
    // Status
    get isInitialized() { return GalleryManager.initialized; },
    get isResourcesLoaded() { return GalleryManager.resourcesLoaded; },
    get isActive() { return !!GalleryManager.activeGallery; }
  };

})();
