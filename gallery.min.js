/**
 * GALLERY.MIN.JS - LightGallery System
 * Gallery interactions với instant loading và progressive enhancement
 */

(function() {
  'use strict';

  // === GALLERY MANAGER ===
  window.DorikGallery = {
    
    lightGalleryLoaded: false,
    activeGallery: null,

    // Initialize gallery system
    async init() {
      // Setup event listeners for gallery triggers
      this.setupEventListeners();
      window.DorikUtils?.log('✅ Gallery system initialized');
    },

    // Setup click event listeners
    setupEventListeners() {
      // Use event delegation for better performance
      document.addEventListener('click', this.handleGalleryClick.bind(this));
    },

    // Handle gallery clicks
    async handleGalleryClick(event) {
      const target = event.target;
      
      // Check if clicked element triggers gallery
      const isMainImage = target.hasAttribute('data-field') && target.getAttribute('data-field') === 'img_main';
      const isSeeMore = target.hasAttribute('data-field') && target.getAttribute('data-field') === 'see_more';
      
      if (!isMainImage && !isSeeMore) {
        return;
      }

      event.preventDefault();
      event.stopPropagation();

      // Get container ID
      const containerId = window.DorikUtils?.findContainerId(target);
      if (!containerId) {
        window.DorikUtils?.error('Container ID not found for gallery');
        return;
      }

      // Track gallery view
      if (window.DorikTracking?.trackEvent) {
        window.DorikTracking.trackEvent('gallery_view', {
          container_id: containerId,
          trigger: isMainImage ? 'main_image' : 'see_more'
        });
      }

      // Update counter
      if (window.DorikState) {
        window.DorikState.counters.galleryViews++;
      }

      // Open gallery
      await this.openGallery(containerId, target);
    },

    // Open gallery with instant loading
    async openGallery(containerId, triggerElement) {
      try {
        // Show loading state
        this.showLoadingState(triggerElement);

        // Load LightGallery if not loaded
        await this.ensureLightGalleryLoaded();

        // Get product data
        const productData = await this.getProductData(containerId);
        if (!productData) {
          throw new Error('Product data not found');
        }

        // Get gallery images
        const images = window.DorikFirebase?.getProductImages(productData) || [];
        if (images.length === 0) {
          throw new Error('No images found for gallery');
        }

        // Create gallery
        await this.createLightGallery(images, triggerElement);

        // Preload remaining images in background
        this.preloadGalleryImages(images);

      } catch (error) {
        window.DorikUtils?.error('Gallery open error:', error);
        this.showErrorState(triggerElement);
      } finally {
        this.hideLoadingState(triggerElement);
      }
    },

    // Ensure LightGallery is loaded
    async ensureLightGalleryLoaded() {
      if (this.lightGalleryLoaded) {
        return;
      }

      const config = window.DorikConfig;
      if (!config) {
        throw new Error('DorikConfig not found');
      }

      try {
        // Load CSS first
        await Promise.all([
          window.DorikUtils.loadCSS(config.LIGHTGALLERY_CSS, 'lg-css'),
          window.DorikUtils.loadCSS(config.LIGHTGALLERY_THUMB_CSS, 'lg-thumb-css')
        ]);

        // Load JS
        await window.DorikUtils.loadJS(config.LIGHTGALLERY_JS, 'lg-js');
        await window.DorikUtils.loadJS(config.LIGHTGALLERY_THUMB_JS, 'lg-thumb-js');

        // Wait for LightGallery to be ready
        await this.waitForLightGallery();

        this.lightGalleryLoaded = true;
        window.DorikUtils?.log('✅ LightGallery loaded');

      } catch (error) {
        throw new Error('Failed to load LightGallery: ' + error.message);
      }
    },

    // Wait for LightGallery to be available
    waitForLightGallery(maxWait = 5000) {
      return new Promise((resolve, reject) => {
        const startTime = Date.now();
        
        const checkLightGallery = () => {
          if (window.lightGallery) {
            resolve();
          } else if (Date.now() - startTime > maxWait) {
            reject(new Error('LightGallery loading timeout'));
          } else {
            setTimeout(checkLightGallery, 100);
          }
        };
        
        checkLightGallery();
      });
    },

    // Get product data
    async getProductData(containerId) {
      if (window.DorikFirebase?.fetchProductData) {
        return await window.DorikFirebase.fetchProductData(containerId);
      }
      
      // Fallback: get from cache only
      return window.DorikCache?.getProduct(containerId) || null;
    },

    // Create LightGallery instance
    async createLightGallery(images, triggerElement) {
      // Create temporary container for gallery
      const galleryContainer = document.createElement('div');
      galleryContainer.style.display = 'none';
      document.body.appendChild(galleryContainer);

      // Add images to container
      images.forEach(image => {
        const item = document.createElement('a');
        item.href = image.src;
        item.setAttribute('data-src', image.src);
        item.setAttribute('data-sub-html', image.title);
        
        const img = document.createElement('img');
        img.src = image.thumb;
        img.alt = image.title;
        
        item.appendChild(img);
        galleryContainer.appendChild(item);
      });

      // Initialize LightGallery
      const gallery = window.lightGallery(galleryContainer, {
        plugins: [window.lgThumbnail],
        mode: 'lg-fade',
        cssEasing: 'cubic-bezier(0.25, 0, 0.25, 1)',
        speed: 150,
        thumbnail: true,
        thumbWidth: 60,
        thumbHeight: 60,
        thumbMargin: 5,
        animateThumb: true,
        allowMediaOverlap: true,
        toggleThumb: true,
        download: false,
        counter: true,
        getCaptionFromTitleOrAlt: false,
        appendSubHtmlTo: '.lg-sub-html',
        subHtmlSelectorRelative: true,
        preload: 2,
        showThumbByDefault: true,
        loadYouTubePoster: false,
        youTubePlayerParams: false,
        vimeoPlayerParams: false,
        loop: true,
        escKey: true,
        keyPress: true,
        controls: true,
        slideEndAnimation: true,
        hideControlOnEnd: false,
        mousewheel: true,
        swipeThreshold: 50,
        enableSwipe: true,
        enableDrag: true
      });

      // Store reference
      this.activeGallery = gallery;

      // Setup gallery events
      galleryContainer.addEventListener('lgAfterClose', () => {
        this.activeGallery = null;
        document.body.removeChild(galleryContainer);
      });

      // Auto-open gallery
      gallery.openGallery(0);
    },

    // Preload gallery images in background
    preloadGalleryImages(images) {
      if (!window.DorikCache?.preloadImages) {
        return;
      }

      const urls = images.slice(1).map(img => img.src); // Skip first image (already loaded)
      if (urls.length > 0) {
        window.DorikCache.preloadImages(urls, 'high')
          .catch(error => {
            window.DorikUtils?.error('Gallery image preload error:', error);
          });
      }
    },

    // Loading states
    showLoadingState(element) {
      element.classList.add('dorik-loading', 'loading-pulse');
      element.style.pointerEvents = 'none';
    },

    hideLoadingState(element) {
      element.classList.remove('dorik-loading', 'loading-pulse');
      element.style.pointerEvents = '';
    },

    showErrorState(element) {
      // Could add error styling here
      window.DorikUtils?.error('Gallery failed to load');
    },

    // Close active gallery
    closeGallery() {
      if (this.activeGallery) {
        this.activeGallery.closeGallery();
      }
    },

    // Gallery stats
    getStats() {
      return {
        lightGalleryLoaded: this.lightGalleryLoaded,
        hasActiveGallery: !!this.activeGallery,
        totalViews: window.DorikState?.counters.galleryViews || 0
      };
    }
  };

  window.DorikUtils?.log('✅ Gallery module loaded');

})();
