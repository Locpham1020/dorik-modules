/**
 * GALLERY.MIN.JS - LightGallery System Module
 * Gallery interactions vá»›i instant loading vÃ  progressive enhancement
 */

(function() {
  'use strict';

  // === GALLERY MANAGER ===
  window.DorikGallery = {
    
    activeGallery: null,
    loadPromise: null,

    // Initialize gallery system
    async init() {
      window.DorikUtils?.log('ðŸ–¼ï¸ Initializing gallery system...');
      
      // Gallery functionality is initialized on-demand
      // No need to load LightGallery until first use
      
      window.DorikUtils?.log('âœ… Gallery system ready (on-demand loading)');
    },

    // Handle gallery click events
    async handleGalleryClick(target, containerId) {
      if (!containerId) {
        window.DorikUtils?.error('âŒ Container ID required for gallery');
        return;
      }

      try {
        window.DorikUtils?.log(`ðŸ–¼ï¸ Opening gallery: ${containerId}`);
        
        // Show loading state
        this.showLoadingState(target);

        // Track gallery view
        if (window.DorikTracking?.trackEvent) {
          window.DorikTracking.trackEvent('gallery_view', {
            container_id: containerId,
            trigger: target.getAttribute('data-field') || 'unknown'
          });
        }

        // Load LightGallery if needed
        await this.ensureLightGalleryLoaded();

        // Get product data
        const productData = await this.getProductData(containerId);
        if (!productData) {
          throw new Error('Product data not found');
        }

        // Get gallery images
        const images = window.DorikFirebase?.getProductImages(productData) || [];
        if (images.length === 0) {
          throw new Error('No images found for gallery');
        }

        // Create gallery
        await this.createLightGallery(images, productData);

        // Preload remaining images in background
        this.preloadGalleryImages(images);

        // Update counter
        if (window.DorikState) {
          window.DorikState.counters.galleryViews++;
        }

      } catch (error) {
        window.DorikUtils?.error('âŒ Gallery error:', error);
        this.showErrorState(target);
      } finally {
        this.hideLoadingState(target);
      }
    },

    // Ensure LightGallery is loaded
    async ensureLightGalleryLoaded() {
      // Prevent multiple loading attempts
      if (this.loadPromise) {
        return this.loadPromise;
      }

      if (window.DorikState?.flags.lightGalleryLoaded) {
        return;
      }

      this.loadPromise = this._loadLightGallery();
      return this.loadPromise;
    },

    async _loadLightGallery() {
      const config = window.DorikConfig;
      if (!config) {
        throw new Error('DorikConfig not found');
      }

      try {
        window.DorikUtils?.log('ðŸ“¦ Loading LightGallery...');

        // Load CSS first (parallel)
        const cssPromises = [
          window.DorikUtils.loadCSS(config.LIGHTGALLERY_CSS, 'lg-css'),
          window.DorikUtils.loadCSS(config.LIGHTGALLERY_THUMB_CSS, 'lg-thumb-css')
        ];
        await Promise.all(cssPromises);

        // Load JS (parallel)
        const jsPromises = [
          window.DorikUtils.loadJS(config.LIGHTGALLERY_JS, 'lg-js'),
          window.DorikUtils.loadJS(config.LIGHTGALLERY_THUMB_JS, 'lg-thumb-js')
        ];
        await Promise.all(jsPromises);

        // Wait for LightGallery to be ready
        await window.DorikUtils.waitFor(() => window.lightGallery && window.lgThumbnail, 5000);

        // Update global state
        if (window.DorikState) {
          window.DorikState.flags.lightGalleryLoaded = true;
        }

        window.DorikUtils?.log('âœ… LightGallery loaded');

      } catch (error) {
        this.loadPromise = null; // Reset for retry
        throw new Error('Failed to load LightGallery: ' + error.message);
      }
    },

    // Get product data
    async getProductData(containerId) {
      if (window.DorikFirebase?.fetchProductData) {
        return await window.DorikFirebase.fetchProductData(containerId);
      }
      
      // Fallback: get from cache only
      if (window.DorikCache?.getProduct) {
        return window.DorikCache.getProduct(containerId);
      }
      
      // Last resort: create mock data
      return this.createMockProductData(containerId);
    },

    // Create mock product data
    createMockProductData(containerId) {
      return {
        name: `Product ${containerId}`,
        img_main: 'https://via.placeholder.com/800x800/4f46e5/ffffff?text=Main+Image',
        img01: 'https://via.placeholder.com/800x800/059669/ffffff?text=Image+1',
        img02: 'https://via.placeholder.com/800x800/dc2626/ffffff?text=Image+2',
        img03: 'https://via.placeholder.com/800x800/ea580c/ffffff?text=Image+3',
        img04: 'https://via.placeholder.com/800x800/7c3aed/ffffff?text=Image+4'
      };
    },

    // Create LightGallery instance
    async createLightGallery(images, productData) {
      // Create temporary container for gallery
      const galleryContainer = document.createElement('div');
      galleryContainer.style.display = 'none';
      galleryContainer.className = 'dorik-gallery-container';
      document.body.appendChild(galleryContainer);

      // Add images to container
      images.forEach((image, index) => {
        const item = document.createElement('a');
        item.href = image.src;
        item.setAttribute('data-src', image.src);
        item.setAttribute('data-sub-html', this.createImageCaption(image, productData, index));
        
        const img = document.createElement('img');
        img.src = image.thumb;
        img.alt = image.title;
        img.loading = 'lazy';
        
        item.appendChild(img);
        galleryContainer.appendChild(item);
      });

      // Get device-specific settings
      const deviceInfo = window.DorikState?.deviceInfo;
      const gallerySettings = this.getGallerySettings(deviceInfo);

      // Initialize LightGallery
      const gallery = window.lightGallery(galleryContainer, gallerySettings);

      // Store reference
      this.activeGallery = gallery;

      // Setup gallery events
      this.setupGalleryEvents(galleryContainer, gallery);

      // Auto-open gallery
      gallery.openGallery(0);
      
      window.DorikUtils?.log(`âœ… Gallery opened with ${images.length} images`);
    },

    // Get device-specific gallery settings
    getGallerySettings(deviceInfo) {
      const baseSettings = {
        plugins: [window.lgThumbnail],
        mode: 'lg-fade',
        cssEasing: 'cubic-bezier(0.25, 0, 0.25, 1)',
        speed: 150,
        thumbnail: true,
        thumbWidth: 60,
        thumbHeight: 60,
        thumbMargin: 5,
        animateThumb: true,
        allowMediaOverlap: true,
        toggleThumb: true,
        download: false,
        counter: true,
        getCaptionFromTitleOrAlt: false,
        appendSubHtmlTo: '.lg-sub-html',
        subHtmlSelectorRelative: true,
        preload: 2,
        showThumbByDefault: true,
        loadYouTubePoster: false,
        youTubePlayerParams: false,
        vimeoPlayerParams: false,
        loop: true,
        escKey: true,
        keyPress: true,
        controls: true,
        slideEndAnimation: true,
        hideControlOnEnd: false,
        mousewheel: true,
        swipeThreshold: 50,
        enableSwipe: true,
        enableDrag: true
      };

      // Mobile-specific adjustments
      if (deviceInfo?.isMobile) {
        baseSettings.thumbWidth = 50;
        baseSettings.thumbHeight = 50;
        baseSettings.thumbMargin = 3;
        baseSettings.preload = 1;
        baseSettings.mousewheel = false;
      }

      // Slow connection adjustments
      if (deviceInfo?.isSlowConnection) {
        baseSettings.preload = 1;
        baseSettings.animateThumb = false;
        baseSettings.slideEndAnimation = false;
      }

      return baseSettings;
    },

    // Create image caption
    createImageCaption(image, productData, index) {
      const title = productData.name || 'Product Image';
      const imageType = image.type === 'main' ? 'Main Image' : `Image ${index}`;
      
      return `<h4>${title}</h4><p>${imageType}</p>`;
    },

    // Setup gallery events
    setupGalleryEvents(container, gallery) {
      // Track gallery interactions
      container.addEventListener('lgSlideItemLoad', () => {
        window.DorikUtils?.log('ðŸ–¼ï¸ Gallery image loaded');
      });

      container.addEventListener('lgAfterSlide', (event) => {
        const slideIndex = event.detail.index;
        window.DorikUtils?.log(`ðŸ–¼ï¸ Gallery slide: ${slideIndex}`);
        
        // Track slide view
        if (window.DorikTracking?.trackEvent) {
          window.DorikTracking.trackEvent('gallery_slide', {
            slide_index: slideIndex,
            total_slides: gallery.galleryItems.length
          });
        }
      });

      // Cleanup on close
      container.addEventListener('lgAfterClose', () => {
        this.activeGallery = null;
        
        // Remove container from DOM
        if (container.parentNode) {
          container.parentNode.removeChild(container);
        }
        
        window.DorikUtils?.log('ðŸ—‘ï¸ Gallery closed and cleaned up');
        
        // Track gallery close
        if (window.DorikTracking?.trackEvent) {
          window.DorikTracking.trackEvent('gallery_close', {
            duration: Date.now() - (this.galleryOpenTime || Date.now())
          });
        }
      });

      // Store open time for duration tracking
      this.galleryOpenTime = Date.now();
    },

    // Preload gallery images in background
    preloadGalleryImages(images) {
      if (!window.DorikCache?.preloadImages) {
        return;
      }

      const urls = images.slice(1).map(img => img.src); // Skip first image (already loaded)
      if (urls.length > 0) {
        window.DorikCache.preloadImages(urls, 'high')
          .then(() => {
            window.DorikUtils?.log(`âœ… Preloaded ${urls.length} gallery images`);
          })
          .catch(error => {
            window.DorikUtils?.error('âŒ Gallery image preload error:', error);
          });
      }
    },

    // Loading states
    showLoadingState(element) {
      if (!element) return;
      
      element.classList.add('dorik-loading', 'loading-pulse');
      element.style.pointerEvents = 'none';
      element.style.opacity = '0.7';
      
      // Add loading indicator
      if (!element.querySelector('.loading-indicator')) {
        const indicator = document.createElement('div');
        indicator.className = 'loading-indicator';
        indicator.innerHTML = 'ðŸ”„';
        indicator.style.cssText = `
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          font-size: 20px;
          animation: spin 1s linear infinite;
          z-index: 10;
        `;
        element.style.position = 'relative';
        element.appendChild(indicator);
      }
    },

    hideLoadingState(element) {
      if (!element) return;
      
      element.classList.remove('dorik-loading', 'loading-pulse');
      element.style.pointerEvents = '';
      element.style.opacity = '';
      
      // Remove loading indicator
      const indicator = element.querySelector('.loading-indicator');
      if (indicator) {
        indicator.remove();
      }
    },

    showErrorState(element) {
      if (!element) return;
      
      element.style.backgroundColor = '#ef4444';
      element.style.color = 'white';
      
      // Show error message temporarily
      const originalContent = element.innerHTML;
      element.innerHTML = 'âŒ Gallery Error';
      
      setTimeout(() => {
        element.style.backgroundColor = '';
        element.style.color = '';
        element.innerHTML = originalContent;
      }, 2000);
      
      window.DorikUtils?.error('Gallery failed to load');
    },

    // Close active gallery
    closeGallery() {
      if (this.activeGallery) {
        this.activeGallery.closeGallery();
      }
    },

    // Manual gallery opener (for testing)
    async openGallery(containerId, images = null) {
      try {
        window.DorikUtils?.log(`ðŸ§ª Manual gallery open: ${containerId}`);
        
        await this.ensureLightGalleryLoaded();
        
        let galleryImages;
        if (images) {
          galleryImages = images;
        } else {
          const productData = await this.getProductData(containerId);
          galleryImages = window.DorikFirebase?.getProductImages(productData) || [];
        }
        
        if (galleryImages.length === 0) {
          galleryImages = [
            {
              src: 'https://via.placeholder.com/800x800/4f46e5/ffffff?text=Demo+Image',
              thumb: 'https://via.placeholder.com/800x800/4f46e5/ffffff?text=Demo+Image',
              title: 'Demo Image'
            }
          ];
        }
        
        await this.createLightGallery(galleryImages, { name: `Product ${containerId}` });
        
      } catch (error) {
        window.DorikUtils?.error('âŒ Manual gallery error:', error);
      }
    },

    // Gallery stats
    getStats() {
      return {
        lightGalleryLoaded: window.DorikState?.flags.lightGalleryLoaded || false,
        hasActiveGallery: !!this.activeGallery,
        totalViews: window.DorikState?.counters.galleryViews || 0,
        isLoading: !!this.loadPromise
      };
    },

    // Cleanup
    cleanup() {
      if (this.activeGallery) {
        this.activeGallery.closeGallery();
        this.activeGallery = null;
      }
      
      this.loadPromise = null;
      this.galleryOpenTime = null;
      
      // Remove any gallery containers
      const containers = document.querySelectorAll('.dorik-gallery-container');
      containers.forEach(container => {
        if (container.parentNode) {
          container.parentNode.removeChild(container);
        }
      });
      
      if (window.DorikState) {
        window.DorikState.flags.lightGalleryLoaded = false;
      }
      
      window.DorikUtils?.log('ðŸ§¹ Gallery system cleaned up');
    }
  };

  // Add CSS for loading animations
  const loadingCSS = `
    @keyframes spin {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }
    
    .loading-pulse {
      animation: dorik-pulse 1.5s infinite;
    }
    
    @keyframes dorik-pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .dorik-loading {
      pointer-events: none;
      user-select: none;
    }
  `;

  // Inject loading CSS
  const style = document.createElement('style');
  style.textContent = loadingCSS;
  document.head.appendChild(style);

  window.DorikUtils?.log('âœ… Gallery module loaded');

})();
