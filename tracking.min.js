/**
 * TRACKING MODULE - Analytics & Event Tracking
 * URL: https://yourname.github.io/dorik-modules/tracking.min.js
 */

window.DorikTracking = (function() {
  'use strict';

  // === TRACKING MANAGER ===
  const TrackingManager = {
    initialized: false,
    trackingQueue: [],
    
    // Initialize tracking
    init() {
      if (this.initialized) return;
      
      this.setupEventListeners();
      this.processTrackingQueue();
      this.initialized = true;
      
      this._log('Tracking Manager initialized');
    },

    // Send tracking data
    sendTracking(platform, containerId, additionalData = {}) {
      if (!containerId) {
        console.warn('No container ID found for tracking');
        return;
      }
      
      const deviceInfo = window.DorikConfig ? 
        window.DorikConfig.Utils.getDeviceInfo() : 
        this.getBasicDeviceInfo();
      
      const affiliateId = window.DorikConfig ? 
        window.DorikConfig.Utils.getAffiliateId() : 
        this.getBasicAffiliateId();
      
      const cacheStats = window.DorikCache ? 
        window.DorikCache.getStats() : 
        { size: 0, memoryMB: '0' };
      
      this._log('Sending tracking:', { platform, containerId, device: deviceInfo.device, os: deviceInfo.os });
      
      const trackingData = {
        platform: platform,
        device: deviceInfo.device,
        os: deviceInfo.os,
        screen: deviceInfo.screenWidth + 'x' + deviceInfo.screenHeight,
        affiliate_id: affiliateId,
        container_id: containerId,
        mobile: deviceInfo.isMobile ? 'true' : 'false',
        connection: deviceInfo.effectiveType,
        cache_size: cacheStats.size || 0,
        memory_mb: cacheStats.memoryMB || '0',
        timestamp: Date.now(),
        ...additionalData
      };
      
      this.sendToGoogleScript(trackingData);
    },

    // Send to Google Script
    sendToGoogleScript(data) {
      const config = window.DorikConfig ? window.DorikConfig.getAll() : {};
      const scriptUrl = config.GOOGLE_SCRIPT_URL || 'https://script.google.com/macros/s/AKfycbylfd_DbjRrq90t0jIDPnjx523WhVzXxF9WtajANBLWyVqqZDqZhKu8z6_GOZ6rf9jTQw/exec';
      
      const queryParams = new URLSearchParams();
      Object.entries(data).forEach(([key, value]) => {
        queryParams.append(key, encodeURIComponent(value));
      });
      
      const trackingUrl = `${scriptUrl}?${queryParams.toString()}`;
      
      const pixel = document.createElement('img');
      pixel.width = 1;
      pixel.height = 1;
      pixel.style.cssText = 'position:absolute;left:-9999px;visibility:hidden;';
      pixel.src = trackingUrl;
      
      // Cleanup after tracking
      pixel.onload = pixel.onerror = () => {
        setTimeout(() => {
          if (pixel?.parentNode) {
            pixel.parentNode.removeChild(pixel);
          }
        }, 1000);
      };
      
      document.body.appendChild(pixel);
    },

    // Track specific events
    trackGalleryView(containerId) {
      this.sendTracking('gallery_view', containerId, {
        event_type: 'gallery_opened',
        feature: 'image_gallery'
      });
    },

    trackOrderClick(containerId) {
      this.sendTracking('order', containerId, {
        event_type: 'order_intent',
        feature: 'order_form'
      });
    },

    trackPlatformClick(platform, containerId) {
      this.sendTracking(platform, containerId, {
        event_type: 'platform_redirect',
        feature: 'external_link'
      });
    },

    trackPageView() {
      const containersOnPage = document.querySelectorAll('[id*="_"]').length;
      this.sendTracking('page_view', 'general', {
        event_type: 'page_load',
        containers_count: containersOnPage,
        page_url: window.location.href,
        referrer: document.referrer || 'direct'
      });
    },

    trackPerformance(metrics) {
      this.sendTracking('performance', 'system', {
        event_type: 'performance_metrics',
        ...metrics
      });
    },

    // Setup event listeners for automatic tracking
    setupEventListeners() {
      // Track page view
      this.trackPageView();
      
      // Track clicks on trackable elements
      document.addEventListener('click', (e) => {
        const element = e.target.closest('[data-field]');
        if (!element) return;
        
        const containerId = this.findContainerId(element);
        if (!containerId) return;
        
        const field = element.getAttribute('data-field');
        
        switch (field) {
          case 'link_shopee':
            this.trackPlatformClick('shopee', containerId);
            break;
          case 'link_tiktok':
            this.trackPlatformClick('tiktok', containerId);
            break;
          case 'img_main':
          case 'see_more':
            this.trackGalleryView(containerId);
            break;
          case 'order':
            this.trackOrderClick(containerId);
            break;
        }
      });
      
      // Track performance metrics
      if ('performance' in window) {
        window.addEventListener('load', () => {
          setTimeout(() => {
            const perf = performance.getEntriesByType('navigation')[0];
            if (perf) {
              this.trackPerformance({
                load_time: Math.round(perf.loadEventEnd - perf.loadEventStart),
                dom_content_loaded: Math.round(perf.domContentLoadedEventEnd - perf.domContentLoadedEventStart),
                first_contentful_paint: this.getFirstContentfulPaint()
              });
            }
          }, 1000);
        });
      }
    },

    // Get First Contentful Paint
    getFirstContentfulPaint() {
      try {
        const perfEntries = performance.getEntriesByType('paint');
        const fcp = perfEntries.find(entry => entry.name === 'first-contentful-paint');
        return fcp ? Math.round(fcp.startTime) : null;
      } catch (e) {
        return null;
      }
    },

    // Queue tracking for offline scenarios
    queueTracking(platform, containerId, additionalData = {}) {
      this.trackingQueue.push({
        platform,
        containerId,
        additionalData,
        timestamp: Date.now()
      });
      
      if (navigator.onLine) {
        this.processTrackingQueue();
      }
    },

    // Process queued tracking events
    processTrackingQueue() {
      if (!navigator.onLine || this.trackingQueue.length === 0) return;
      
      const queue = [...this.trackingQueue];
      this.trackingQueue = [];
      
      queue.forEach(({ platform, containerId, additionalData }) => {
        this.sendTracking(platform, containerId, additionalData);
      });
    },

    // Fallback device info
    getBasicDeviceInfo() {
      const width = window.innerWidth;
      const isMobile = width <= 768;
      
      return {
        device: isMobile ? 'mobile' : 'desktop',
        os: navigator.platform || 'Unknown',
        screenWidth: width,
        screenHeight: window.innerHeight,
        isMobile: isMobile,
        effectiveType: '4g',
        isSlowConnection: false
      };
    },

    // Fallback affiliate ID
    getBasicAffiliateId() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('aff') || urlParams.get('ref') || 'direct';
    },

    // Find container ID
    findContainerId(element) {
      if (window.DorikConfig && window.DorikConfig.Utils) {
        return window.DorikConfig.Utils.findContainerId(element);
      }
      
      let container = element;
      while (container && !container.id) {
        container = container.parentElement;
        if (!container) break;
      }
      return container?.id || null;
    },

    _log(message, data = null) {
      if (window.DorikConfig && window.DorikConfig.Utils) {
        window.DorikConfig.Utils.log(message, data);
      }
    }
  };

  // Setup online/offline listeners
  window.addEventListener('online', () => {
    TrackingManager.processTrackingQueue();
  });

  // === PUBLIC API ===
  return {
    // Initialize tracking
    init: () => TrackingManager.init(),
    
    // Manual tracking methods
    send: (platform, containerId, data) => TrackingManager.sendTracking(platform, containerId, data),
    queue: (platform, containerId, data) => TrackingManager.queueTracking(platform, containerId, data),
    
    // Specific event tracking
    trackGallery: (containerId) => TrackingManager.trackGalleryView(containerId),
    trackOrder: (containerId) => TrackingManager.trackOrderClick(containerId),
    trackPlatform: (platform, containerId) => TrackingManager.trackPlatformClick(platform, containerId),
    trackPageView: () => TrackingManager.trackPageView(),
    trackPerformance: (metrics) => TrackingManager.trackPerformance(metrics),
    
    // Queue management
    processQueue: () => TrackingManager.processTrackingQueue(),
    
    // Status
    get isInitialized() { return TrackingManager.initialized; },
    get queueLength() { return TrackingManager.trackingQueue.length; }
  };

})();
