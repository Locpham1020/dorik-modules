/**
 * TRACKING.MIN.JS - Analytics & Affiliate Tracking Module
 * Google Apps Script integration, event tracking, platform detection
 */

(function() {
  'use strict';

  // === TRACKING SYSTEM ===
  window.DorikTracking = {
    
    eventQueue: [],
    isOnline: navigator.onLine,
    initialized: false,

    // Initialize tracking system
    async init() {
      window.DorikUtils?.log('üìä Initializing tracking system...');
      
      // Setup online/offline detection
      this.setupNetworkDetection();
      
      // Setup platform click tracking
      this.setupPlatformTracking();
      
      // Process any queued events
      this.processEventQueue();
      
      // Track initial page view
      this.trackPageView();
      
      this.initialized = true;
      
      // Update global state
      if (window.DorikState) {
        window.DorikState.flags.trackingReady = true;
      }
      
      window.DorikUtils?.log('‚úÖ Tracking system ready');
    },

    // Setup network status detection
    setupNetworkDetection() {
      window.addEventListener('online', () => {
        this.isOnline = true;
        window.DorikUtils?.log('üåê Back online - processing queued events');
        this.processEventQueue();
      });

      window.addEventListener('offline', () => {
        this.isOnline = false;
        window.DorikUtils?.log('üì¥ Offline - events will be queued');
      });
    },

    // Setup platform click tracking
    setupPlatformTracking() {
      // Event delegation will be handled by main click handler
      // This method sets up platform detection patterns
      window.DorikUtils?.log('üîó Platform tracking patterns ready');
    },

    // Main event tracking function
    async trackEvent(eventName, eventData = {}) {
      if (!eventName) {
        window.DorikUtils?.error('Event name is required');
        return;
      }

      try {
        // Prepare tracking data
        const trackingData = this.prepareTrackingData(eventName, eventData);
        
        // Update global counter
        if (window.DorikState) {
          window.DorikState.counters.trackingEvents++;
        }
        
        // Send event
        if (this.isOnline) {
          await this.sendEvent(trackingData);
        } else {
          // Queue for later if offline
          this.eventQueue.push({ 
            eventName, 
            eventData: trackingData, 
            timestamp: Date.now() 
          });
          window.DorikUtils?.log(`üìã Event queued: ${eventName}`);
        }

      } catch (error) {
        window.DorikUtils?.error('‚ùå Tracking error:', error);
        
        // Queue event for retry
        this.eventQueue.push({ 
          eventName, 
          eventData, 
          timestamp: Date.now(),
          retryCount: (eventData.retryCount || 0) + 1
        });
      }
    },

    // Prepare tracking data with device info
    prepareTrackingData(eventName, eventData) {
      const deviceInfo = window.DorikState?.deviceInfo || window.DorikUtils?.getDeviceInfo();
      const affiliateId = window.DorikUtils?.getAffiliateId();
      
      return {
        event: eventName,
        timestamp: new Date().toISOString(),
        page_url: window.location.href,
        page_title: document.title,
        referrer: document.referrer || 'direct',
        affiliate_id: affiliateId,
        
        // Device information
        device_type: deviceInfo?.device || 'unknown',
        os: deviceInfo?.os || 'unknown',
        screen_width: deviceInfo?.screenWidth || window.innerWidth,
        screen_height: deviceInfo?.screenHeight || window.innerHeight,
        user_agent: deviceInfo?.userAgent || navigator.userAgent,
        connection_type: deviceInfo?.effectiveType || 'unknown',
        is_mobile: deviceInfo?.isMobile || false,
        is_slow_connection: deviceInfo?.isSlowConnection || false,
        
        // Performance info
        performance_memory: this.getMemoryInfo(),
        page_load_time: this.getPageLoadTime(),
        
        // Session info
        session_id: this.getSessionId(),
        visit_count: this.getVisitCount(),
        
        // Custom event data
        ...eventData
      };
    },

    // Send event to Google Apps Script
    async sendEvent(trackingData) {
      const config = window.DorikConfig;
      if (!config?.GOOGLE_SCRIPT_URL) {
        throw new Error('Google Script URL not configured');
      }

      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 10000); // 10s timeout

      try {
        const response = await fetch(config.GOOGLE_SCRIPT_URL, {
          method: 'POST',
          mode: 'cors',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(trackingData),
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) {
          throw new Error(`Tracking request failed: ${response.status} ${response.statusText}`);
        }

        const result = await response.json();
        window.DorikUtils?.log('üìä Event tracked:', trackingData.event);
        return result;

      } catch (error) {
        clearTimeout(timeoutId);
        
        if (error.name === 'AbortError') {
          throw new Error('Tracking request timeout');
        }
        
        throw error;
      }
    },

    // Process queued events
    async processEventQueue() {
      if (!this.isOnline || this.eventQueue.length === 0) {
        return;
      }

      window.DorikUtils?.log(`üì§ Processing ${this.eventQueue.length} queued events`);
      
      const eventsToProcess = [...this.eventQueue];
      this.eventQueue = [];

      for (const queuedEvent of eventsToProcess) {
        try {
          // Skip events that are too old (older than 1 hour)
          const eventAge = Date.now() - queuedEvent.timestamp;
          if (eventAge > 3600000) {
            window.DorikUtils?.log('‚è∞ Skipping old event:', queuedEvent.eventName);
            continue;
          }

          // Skip events with too many retries
          if (queuedEvent.retryCount && queuedEvent.retryCount > 3) {
            window.DorikUtils?.log('‚ùå Max retries reached:', queuedEvent.eventName);
            continue;
          }

          // Update timestamp for queued events
          if (queuedEvent.eventData) {
            queuedEvent.eventData.queued_timestamp = new Date(queuedEvent.timestamp).toISOString();
            queuedEvent.eventData.processed_timestamp = new Date().toISOString();
          }

          await this.sendEvent(queuedEvent.eventData || queuedEvent);
          
        } catch (error) {
          window.DorikUtils?.error('‚ùå Failed to process queued event:', error);
          
          // Re-queue with retry count
          queuedEvent.retryCount = (queuedEvent.retryCount || 0) + 1;
          if (queuedEvent.retryCount <= 3) {
            this.eventQueue.push(queuedEvent);
          }
        }
      }
    },

    // Platform detection
    detectPlatform(url) {
      const platformPatterns = {
        'shopee': /shopee\.(vn|com|sg|my|th|ph|tw|br|co\.id|pl)/i,
        'tiktok': /tiktok\.com|tiktokshop/i,
        'lazada': /lazada\.(vn|com|sg|my|th|ph|co\.id)/i,
        'sendo': /sendo\.vn/i,
        'tiki': /tiki\.vn/i,
        'facebook': /facebook\.com|fb\.com/i,
        'instagram': /instagram\.com/i,
        'zalo': /zalo\.me/i,
        'telegram': /t\.me|telegram/i,
        'youtube': /youtube\.com|youtu\.be/i,
        'amazon': /amazon\.(com|vn|sg|jp|uk|de|fr|it|es|ca|au|in|br|mx)/i,
        'alibaba': /alibaba\.com|aliexpress\.com/i,
        'ebay': /ebay\.(com|vn|sg|my|th|ph|tw|au|uk|de|fr|it|es|ca)/i,
        'whatsapp': /wa\.me|whatsapp\.com/i,
        'viber': /viber\.com/i,
        'line': /line\.me/i
      };

      for (const [platform, pattern] of Object.entries(platformPatterns)) {
        if (pattern.test(url)) {
          return platform;
        }
      }

      return null;
    },

    // Handle platform clicks
    handlePlatformClick(link, containerId) {
      const href = link.getAttribute('href');
      if (!href) return false;

      const platform = this.detectPlatform(href);
      if (!platform) return false;

      // Track platform click
      this.trackEvent('platform_click', {
        container_id: containerId,
        platform: platform,
        url: href,
        link_text: link.textContent?.trim() || '',
        link_position: this.getLinkPosition(link)
      });

      // Update counter
      if (window.DorikState) {
        window.DorikState.counters.platformClicks++;
      }

      window.DorikUtils?.log(`üîó Platform click tracked: ${platform}`);
      return true;
    },

    // Get link position info
    getLinkPosition(link) {
      const rect = link.getBoundingClientRect();
      return {
        x: Math.round(rect.left),
        y: Math.round(rect.top),
        width: Math.round(rect.width),
        height: Math.round(rect.height)
      };
    },

    // Track page view
    trackPageView() {
      this.trackEvent('page_view', {
        pathname: window.location.pathname,
        search: window.location.search,
        hash: window.location.hash,
        language: navigator.language,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
      });
    },

    // Track scroll depth
    trackScrollDepth(depth) {
      this.trackEvent('scroll_depth', {
        depth: Math.round(depth),
        max_scroll: Math.round((window.scrollY / (document.body.scrollHeight - window.innerHeight)) * 100)
      });
    },

    // Track performance metrics
    trackPerformance() {
      if (!performance.getEntriesByType) {
        return;
      }

      const navigation = performance.getEntriesByType('navigation')[0];
      if (!navigation) {
        return;
      }

      this.trackEvent('performance', {
        load_time: Math.round(navigation.loadEventEnd - navigation.loadEventStart),
        dom_ready_time: Math.round(navigation.domContentLoadedEventEnd - navigation.domContentLoadedEventStart),
        dns_time: Math.round(navigation.domainLookupEnd - navigation.domainLookupStart),
        tcp_time: Math.round(navigation.connectEnd - navigation.connectStart),
        response_time: Math.round(navigation.responseEnd - navigation.responseStart),
        transfer_size: navigation.transferSize || 0,
        encoded_body_size: navigation.encodedBodySize || 0,
        decoded_body_size: navigation.decodedBodySize || 0
      });
    },

    // Track error
    trackError(error, context = '') {
      this.trackEvent('error', {
        message: error.message || String(error),
        stack: error.stack || '',
        context: context,
        user_agent: navigator.userAgent,
        url: window.location.href,
        line: error.lineno || null,
        column: error.colno || null,
        filename: error.filename || null
      });
    },

    // Track cache performance
    trackCachePerformance() {
      const cacheStats = window.DorikCache?.getStats();
      
      if (cacheStats) {
        this.trackEvent('cache_performance', {
          product_cache: cacheStats.productCache,
          image_cache: cacheStats.imageCache,
          image_preloader: cacheStats.imagePreloader,
          global_counters: window.DorikState?.counters || {}
        });
      }
    },

    // Get memory information
    getMemoryInfo() {
      return window.DorikUtils?.getMemoryInfo() || null;
    },

    // Get page load time
    getPageLoadTime() {
      if (!performance.timing) {
        return null;
      }

      const timing = performance.timing;
      return {
        dom_ready: timing.domContentLoadedEventEnd - timing.navigationStart,
        page_load: timing.loadEventEnd - timing.navigationStart,
        dns_lookup: timing.domainLookupEnd - timing.domainLookupStart,
        tcp_connect: timing.connectEnd - timing.connectStart,
        server_response: timing.responseEnd - timing.requestStart
      };
    },

    // Session management
    getSessionId() {
      let sessionId = sessionStorage.getItem('dorik_session_id');
      if (!sessionId) {
        sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        sessionStorage.setItem('dorik_session_id', sessionId);
      }
      return sessionId;
    },

    getVisitCount() {
      let visitCount = parseInt(localStorage.getItem('dorik_visit_count') || '0');
      visitCount++;
      localStorage.setItem('dorik_visit_count', visitCount.toString());
      return visitCount;
    },

    // Batch track multiple events
    async batchTrackEvents(events) {
      if (!Array.isArray(events) || events.length === 0) {
        return;
      }

      const batchData = {
        batch: true,
        timestamp: new Date().toISOString(),
        events: events.map(event => this.prepareTrackingData(event.name, event.data))
      };

      try {
        await this.sendEvent(batchData);
        window.DorikUtils?.log(`‚úÖ Batch tracked ${events.length} events`);
      } catch (error) {
        window.DorikUtils?.error('‚ùå Batch tracking error:', error);
        // Fall back to individual tracking
        for (const event of events) {
          await this.trackEvent(event.name, event.data);
        }
      }
    },

    // Get tracking stats
    getStats() {
      return {
        initialized: this.initialized,
        isOnline: this.isOnline,
        queuedEvents: this.eventQueue.length,
        globalCounters: window.DorikState?.counters || {},
        sessionId: this.getSessionId(),
        visitCount: this.getVisitCount()
      };
    },

    // Cleanup
    cleanup() {
      // Send final batch of events using beacon API
      if (this.eventQueue.length > 0) {
        this.sendBeaconEvents();
      }
      
      this.eventQueue = [];
      this.initialized = false;
      
      if (window.DorikState) {
        window.DorikState.flags.trackingReady = false;
      }
      
      window.DorikUtils?.log('üßπ Tracking system cleaned up');
    },

    // Send events using beacon API for cleanup
    sendBeaconEvents() {
      const config = window.DorikConfig;
      if (!config?.GOOGLE_SCRIPT_URL || this.eventQueue.length === 0 || !navigator.sendBeacon) {
        return;
      }

      const batchData = {
        batch: true,
        beacon: true,
        timestamp: new Date().toISOString(),
        events: this.eventQueue.map(event => 
          event.eventData || this.prepareTrackingData(event.eventName, event.eventData)
        )
      };

      try {
        navigator.sendBeacon(
          config.GOOGLE_SCRIPT_URL,
          JSON.stringify(batchData)
        );
        window.DorikUtils?.log(`üì° Beacon sent ${this.eventQueue.length} events`);
        this.eventQueue = [];
      } catch (error) {
        window.DorikUtils?.error('‚ùå Beacon send error:', error);
      }
    }
  };

  // Setup global error tracking
  window.addEventListener('error', (event) => {
    if (window.DorikTracking?.trackError) {
      window.DorikTracking.trackError(event.error, 'global_error');
    }
  });

  // Setup unhandled promise rejection tracking
  window.addEventListener('unhandledrejection', (event) => {
    if (window.DorikTracking?.trackError) {
      window.DorikTracking.trackError(event.reason, 'unhandled_promise');
    }
  });

  window.DorikUtils?.log('‚úÖ Tracking module loaded');

})();
